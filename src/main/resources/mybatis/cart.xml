<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="dev.mvc.cart.CartDAOInter">

  <!-- 1. 장바구니 항목 등록 -->
  <insert id="create" parameterType="dev.mvc.cart.CartVO">
    INSERT INTO cart(cartno, memberno, productsno, cnt, selected, rdate, point)
    VALUES(cart_seq.NEXTVAL, #{memberno}, #{productsno}, #{cnt}, #{selected}, SYSDATE, #{point})
  </insert>

  <!-- 2. 회원별 장바구니 목록 조회 (Products JOIN 포함) -->
  <select id="list_by_memberno" resultMap="CartResultMap" parameterType="int">
    SELECT C.cartno, C.memberno, C.productsno, C.cnt, C.selected, C.rdate,
           P.productsno AS "productsVO.productsno",
           P.title       AS "productsVO.title",
           P.thumb1      AS "productsVO.thumb1",
           P.price       AS "productsVO.price",
           P.saleprice   AS "productsVO.saleprice",
           P.dc          AS "productsVO.dc",
           P.expdate     AS "productsVO.expdate",
           P.point AS "productsVO.point"
    FROM cart C
    JOIN products P ON C.productsno = P.productsno
    WHERE C.memberno = #{memberno}
    ORDER BY C.cartno DESC
  </select>

  <!-- 3. 회원 + 상품 조합으로 기존 항목 조회 -->
  <select id="read_by_memberno_productsno" resultType="dev.mvc.cart.CartVO">
    SELECT * FROM cart
    WHERE memberno = #{memberno} AND productsno = #{productsno}
  </select>

  <!-- 4. 수량 변경 -->
  <update id="update_cnt">
    UPDATE cart
    SET cnt = #{cnt}
    WHERE cartno = #{cartno}
  </update>

  <!-- 5. 개별 항목 삭제 -->
  <delete id="delete" parameterType="int">
    DELETE FROM cart
    WHERE cartno = #{cartno}
  </delete>

  <!-- 6. 회원별 전체 삭제 -->
  <delete id="delete_by_memberno" parameterType="int">
    DELETE FROM cart
    WHERE memberno = #{memberno}
  </delete>

  <!-- 7. 총 결제 금액 계산 (saleprice * cnt 합) -->
  <select id="sum_total_price" parameterType="int" resultType="int">
    SELECT NVL(SUM(P.saleprice * C.cnt), 0)
    FROM cart C
    JOIN products P ON C.productsno = P.productsno
    WHERE C.memberno = #{memberno}
  </select>
  
  <resultMap id="CartResultMap" type="dev.mvc.cart.CartVO">
    <id property="cartno" column="cartno" />
    <result property="memberno" column="memberno" />
    <result property="productsno" column="productsno" />
    <result property="cnt" column="cnt" />
    <result property="rdate" column="rdate" />
    <result property="selected" column="selected" />

  
    <association property="productsVO" javaType="dev.mvc.products.ProductsVO">
      <id property="productsno" column="productsVO.productsno" />
      <result property="title" column="productsVO.title" />
      <result property="thumb1" column="productsVO.thumb1" />
      <result property="price" column="productsVO.price" />
      <result property="saleprice" column="productsVO.saleprice" />
      <result property="dc" column="productsVO.dc" />
      <result property="expdate" column="productsVO.expdate" />
      <result property="point" column="productsVO.point" />
    </association>
  </resultMap>
  
  <update id="update_selected" parameterType="map">
    UPDATE cart
    SET selected = #{selected}
    WHERE cartno = #{cartno}
  </update>
  
  <!-- 총 상품 정가 계산: 정가(price) * 수량(cnt)의 합 -->
  <select id="sum_total_price_origin" resultType="int" parameterType="int">
    SELECT NVL(SUM(P.price * C.cnt), 0)
    FROM cart C
    JOIN products P ON C.productsno = P.productsno
    WHERE C.memberno = #{memberno}
  </select>

  <!-- 총 할인 금액 계산: (정가 - 할인가) * 수량 -->
  <select id="sum_total_discount" resultType="int" parameterType="int">
    SELECT NVL(SUM((P.price - P.saleprice) * C.cnt), 0)
    FROM cart C
    JOIN products P ON C.productsno = P.productsno
    WHERE C.memberno = #{memberno}
  </select>

  <!-- 선택된 장바구니 항목 목록 조회 (selected = 'Y') -->
  <select id="list_selected_by_memberno" resultMap="CartResultMap" parameterType="int">
    SELECT C.cartno, C.memberno, C.productsno, C.cnt, C.rdate,
           P.productsno AS "productsVO.productsno",
           P.title       AS "productsVO.title",
           P.thumb1      AS "productsVO.thumb1",
           P.price       AS "productsVO.price",
           P.saleprice   AS "productsVO.saleprice",
           P.dc          AS "productsVO.dc",
           P.expdate     AS "productsVO.expdate",
           P.point       AS "productsVO.point"
    FROM cart C
    JOIN products P ON C.productsno = P.productsno
    WHERE C.memberno = #{memberno}
      AND C.selected = 'Y'
    ORDER BY C.cartno ASC
</select>
  
  <!-- 선택된 장바구니 항목의 총 결제 금액 계산 -->
  <select id="total_selected_by_memberno" resultType="int" parameterType="int">
    SELECT NVL(SUM(P.saleprice * C.cnt), 0)
    FROM cart C
    JOIN products P ON C.productsno = P.productsno
    WHERE C.memberno = #{memberno}
      AND C.selected = 'Y'
  </select>
  
  <!-- 선택된 장바구니 삭제 
  <delete id="delete_selected_by_memberno" parameterType="int">
    DELETE FROM cart
    WHERE memberno = #{memberno}
      AND selected = 'Y'
  </delete>-->
  
  <!-- Order에서 주문하기 버튼 눌렀을 시 Cart/list에서 Y체크된 애들 삭제 -->
  <delete id="delete_selected_by_memberno" parameterType="int">
    DELETE FROM cart WHERE memberno = #{memberno} AND selected = 'Y'
  </delete>

  <!-- 장바구니 건수 조회 -->
  <select id="countItems" resultType="int" parameterType="int">
    SELECT COUNT(*) FROM cart WHERE memberno = #{memberno}
  </select>

  <select id="count_by_member" resultType="int" parameterType="int">
    SELECT COUNT(*) 
    FROM cart
    WHERE memberno = #{memberno}
  </select>
  
  <select id="countByMemberProduct" parameterType="map" resultType="int">
      SELECT COUNT(*) FROM cart
      WHERE memberno = #{memberno} AND productsno = #{productsno}
  </select>


</mapper>
