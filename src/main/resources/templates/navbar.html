<div th:fragment="navbarFragment">
  <div class="top_menu_img">
    <div class="top_menu_label">SoOn 마켓</div>

    <link rel="stylesheet" th:href="@{/css/navbar.css}">
  </div>
  
  <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
    <div class="container-fluid">
      <a class="navbar-brand" href="/">HOME</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown"
          aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
        
      <!-- 메뉴 시작 -->
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item dropdown" th:each="cateVOMenu:${menu}"> <!--/* 대분류 */-->
            <!--/* 대분류명(카테고리 그룹) 출력, private String genre; */-->
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" 
                  role="button" data-bs-toggle="dropdown" aria-expanded="false" th:text="${cateVOMenu.grp}">                                                            
            </a>

            <!--/* 중분류명(카테고리) 출력, private ArrayList<CateVO> list_name; */-->
            <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                <li th:each="cateVO:${cateVOMenu.list_name}">
                  <a class="dropdown-item" th:href="@{|/products/list_by_cateno_grid?cateno=${cateVO.cateno}|}" th:text="${cateVO.name}"></a>
                </li>
            </ul>              
          </li>

          <li class="nav-item"><a class="nav-link" th:href="@{|/calendar/list_calendar|}">월간 일정</a></li>

          <!-- 공지사항 (강조 + 아이콘) -->
          <li class="nav-item">
            <a class="nav-link fw-bold text-primary" th:href="@{|/notice/list|}">
              <i class="bi bi-megaphone"></i> 게시판
            </a>
          </li>

          <!-- 기존 관리자, 회원 메뉴 아래에 추가할 부분 -->
          <li class="nav-item dropdown" th:if="${session.memberno != null}">
            <a class="nav-link dropdown-toggle" href="#" id="userMenuDropdown"
              role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <span th:text="|${session.mname} 님|"></span>
            </a>
            <ul class="dropdown-menu" aria-labelledby="userMenuDropdown">
              <li><a class="dropdown-item" th:href="@{/member/mypage}">마이페이지</a></li>
              <!-- <li><a class="dropdown-item" th:href="@{/member/passwd_update}">비밀번호 변경</a></li> -->
              <!-- <li><a class="dropdown-item" th:href="@{/login/mylist}">내 로그인 내역</a></li> -->
              <li><a class="dropdown-item" th:href="@{/cart/list}">장바구니</a></li>

              <!-- 관리자만 비밀번호 변경 -->
              <li th:if="${session.grade == 'admin'}">
                  <a class="dropdown-item" th:href="@{/member/passwd_update}">비밀번호 변경</a>
              </li>

              <!-- 소비자용 -->
              <li th:if="${session.grade == 'user'}">
                <a class="dropdown-item" th:href="@{/productsgood/user_liked_list}">내가 추천한 상품</a>
                <a class="dropdown-item" th:href="@{/order/list_by_member}">주문 목록</a>

              </li>

              <!-- 공급자용 -->
              <li th:if="${session.grade == 'supplier'}">
                <a class="dropdown-item" th:href="@{/productsgood/supplier_products_liked}">내 상품 추천 내역</a>
                <a class="dropdown-item" th:href="@{/order/list_by_supplier}">내 상품 주문 내역</a> <!-- ✅ 추가 -->
              </li>
              <li><a class="dropdown-item" th:href="@{/member/logout}">로그아웃</a></li>
            </ul>

          <li class="nav-item dropdown" th:if="${session.memberno == null}">
            <a class="nav-link dropdown-toggle" href="#" id="guestMenuDropdown"
              role="button" data-bs-toggle="dropdown" aria-expanded="false">
              계정
            </a>
            <ul class="dropdown-menu" aria-labelledby="guestMenuDropdown">
              <li><a class="dropdown-item" th:href="@{/member/login}">로그인</a></li>
              <li><a class="dropdown-item" th:href="@{/member/create}">회원가입</a></li>
            </ul>
          </li>

          <!-- ✅ navbar.html (알림 팝업 최적화 완성본) -->
          <li class="nav-item" style="position: relative;">
            <a class="nav-link" href="javascript:void(0);" onclick="toggleNotificationPopup()">
              🔔
              <span id="notificationCount" class="badge bg-danger" style="display:none;">0</span>
            </a>
          </li>

          <!-- 아이디 찾기 (별도 nav-item)
          <li class="nav-item" th:if="${session.memberno == null}">
            <a class="nav-link" th:href="@{/member/find_id}">아이디 찾기</a>
          </li>

          비밀번호 찾기 (별도 nav-item)
          <li class="nav-item" th:if="${session.memberno == null}">
            <a class="nav-link" th:href="@{/member/find_passwd}">비밀번호 찾기</a>
          </li> -->
          
          <!-- <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" 
                  role="button" data-bs-toggle="dropdown" aria-expanded="false" th:text="회원">                                                            
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                  <li class="nav-item">
                      <a class="nav-link" th:href="@{|/member/create|}">회원 가입</a>
                  </li>
                  <li class="nav-item" th:if="${session.memberno != null}">
                      <a class="nav-link" th:href="@{|/member/passwd_update|}">비밀 번호 변경</a>
                  </li>  
              </ul>
          </li> -->

          <!-- <li class="nav-item dropdown" th:if="${session.grade=='admin'}">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" 
                      role="button" data-bs-toggle="dropdown" aria-expanded="false" th:text="공급자 AI 서비스">                                                            
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                  <li class="nav-item"><a class="nav-link" th:href="@{|/openai/translator|}">번역 서비스</a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{|/openai/movie|}">영화 추천</a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{|/openai/genre|}">나의 관심 분야 알기</a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{|/openai/summary|}">요약 서비스</a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{|/openai/emotion|}">감정 분석</a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{|/openai/member_img|}">이미지 생성 서비스</a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{|/openai/flower|}">꽃병 상품 등록</a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{|/openai/rabbit|}">Rabbit 상품 등록</a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{|/mail/form|}">메일 쓰기</a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{|/mail/form_file|}">첨부 파일메일 쓰기</a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{|/mail/form_openai|}">번역 기능 지원 메일 쓰기</a></li>
              </ul>
         </li>
           -->

          <li class="nav-item dropdown" th:if="${session.grade=='admin'}">
              <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" 
                      role="button" data-bs-toggle="dropdown" aria-expanded="false" th:text="관리자메뉴">                                                            
              </a>
              <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                  <li class="nav-item"><a class="nav-link" th:href="@{|/cate/list_search?word=${word}|}">카테고리 목록</a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{|/member/list|}">회원 목록</a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{|/products/list_all|}">전체 글 목록</a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{|/calendar/create|}">일정 등록</a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{|/calendar/list_all|}">일정 목록</a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{|/productsgood/list_all|}">추천 목록</a></li>
                  <li class="nav-item"><a class="nav-link" th:href="@{/order/list_all}">전체 주문 내역</a></li>
              </ul>
          </li>
          
          <li class="nav-item">
            <span th:if="${session.memberno == null}"><a class="nav-link" href="/member/login" th:text="로그인"></a></span>
            <span th:if="${session.memberno != null}"><a class="nav-link" href="/member/logout" th:text="|${session.id} 로그아웃|"></a></span>
          </li>                
        </ul>
      </div>
      <!-- 메뉴 종료 -->
          
    </div>  
  </nav>

  <!-- ✅ JavaScript: 알림 팝업을 동적으로 생성 -->
  <script>
  function toggleNotificationPopup() {
    const container = document.querySelector('.nav-item[style*="position: relative;"]');
    let popup = container.querySelector('#notificationPopup');

    if (!popup) {
      popup = document.createElement('div');
      popup.id = 'notificationPopup';
      popup.classList.add('notification-popup');
      popup.style.position = 'absolute';
      popup.style.top = '100%';
      popup.style.right = '0';
      popup.style.backgroundColor = '#fff7d6';
      popup.style.width = '320px';
      popup.style.borderRadius = '12px';
      popup.style.boxShadow = '0 8px 20px rgba(0, 0, 0, 0.5)';
      popup.style.padding = '20px';
      popup.style.marginTop = '10px';
      popup.style.zIndex = '9999';
      container.appendChild(popup);
    }

    // 토글
    popup.style.display = (popup.style.display === 'none' || popup.style.display === '') ? 'block' : 'none';

    if (popup.style.display === 'block') {
      fetch('/notification/list_popup')
        .then(response => response.text())
        .then(html => {
          popup.innerHTML = html;
        });
    }
  }

  // 알림 개수 가져오기
  fetch('/notification/count')
    .then(response => response.text())
    .then(count => {
      const badge = document.getElementById('notificationCount');
      if (parseInt(count) > 0) {
        badge.textContent = count;
        badge.style.display = 'inline-block';
      } else {
        badge.style.display = 'none';
      }
    });
</script>
</div>
