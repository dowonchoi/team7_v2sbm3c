<div th:fragment="navbarFragment">
  <!-- ✅ 상단 유틸 메뉴 -->
  <div class="top-util d-flex justify-content-between px-4 py-1 bg-white border-bottom small text-secondary" style="font-size: 13px;">
    <div>
      <a href="#" class="me-3 text-decoration-none text-secondary">판매자센터</a>
      <a th:href="@{/notice/list}" class="me-3 text-decoration-none text-secondary">게시판</a>
      <a th:href="@{/faq/list}" class="me-3 text-decoration-none text-secondary">FAQ</a>
      <a href="#" class="text-decoration-none text-secondary">이벤트</a>
    </div>
    <div>
      <th:block th:if="${session.memberno == null}">
        <a th:href="@{/member/create}" class="me-3 text-decoration-none text-secondary">회원가입</a>
        <a th:href="@{/member/login}" class="me-3 text-decoration-none text-secondary">로그인</a>
      </th:block>
      <th:block th:if="${session.memberno != null}">
        <a th:href="@{/member/mypage}" class="me-3 text-dark text-decoration-none" th:text="${session.mname + ' 님'}"></a>
        <a th:href="@{/member/logout}" class="me-3 text-decoration-none text-secondary">로그아웃</a>
      </th:block>
      <a th:href="@{/inquiry/list_by_member}" class="text-decoration-none text-secondary">1:1 문의하기</a>
    </div>
  </div>

  <!-- ✅ 네비게이션 바 (로고 + 검색창 + 아이콘) -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top shadow-sm">
    <div class="container-fluid d-flex align-items-center justify-content-between">
      <!-- ✅ 로고 + 검색창 묶기 -->
      <div class="d-flex align-items-center flex-grow-1">
        <a href="/" class="navbar-brand fw-bold me-3" style="font-size: 24px; background: linear-gradient(to right, #00c853, #fbb034, #fdd835); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-decoration: none;">
          SoOn 마켓
        </a>
        <form class="d-flex flex-grow-1" style="max-width: 450px;">
          <input class="form-control me-2" type="search" placeholder="검색어를 입력해주세요" aria-label="Search">
          <button class="btn btn-outline-success" type="submit">검색</button>
        </form>
      </div>
      <!-- ✅ 아이콘들 -->
      <div class="d-flex align-items-center ms-3">
        <th:block th:if="${session.memberno != null}">
          <a href="#" class="me-3 text-dark position-relative" onclick="toggleNotificationPopup()">
            <i class="bi bi-bell-fill" style="font-size: 20px;"></i>
            <span id="notificationCount" class="badge bg-danger position-absolute top-0 start-100 translate-middle" style="display:none; font-size: 10px;">0</span>
          </a>
          <a th:href="@{/order/list_by_member}" class="text-dark">
            <i class="bi bi-cart" style="font-size: 20px;"></i>
          </a>
        </th:block>
      </div>
    </div>
  </nav>

  <!-- ✅ 카테고리 메뉴 -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light border-bottom">
    <div class="container-fluid">
      <div class="collapse navbar-collapse" id="navbarNavDropdown">
        <ul class="navbar-nav">
          <li class="nav-item dropdown" th:each="cateVOMenu:${menu}">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false" th:text="${cateVOMenu.grp}"></a>
            <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
              <li th:each="cateVO:${cateVOMenu.list_name}">
                <a class="dropdown-item" th:href="@{|/products/list_by_cateno_grid?cateno=${cateVO.cateno}|}" th:text="${cateVO.name}"></a>
              </li>
            </ul>
          </li>
          <li class="nav-item"><a class="nav-link" th:href="@{/calendar/list_calendar}">월간 일정</a></li>
          <li class="nav-item" th:if="${session.memberno != null and session.grade != 'admin'}">
            <a class="nav-link" th:href="@{/inquiry/list_by_member}">문의</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- 알림 팝업 스크립트 -->
  <script>
    function toggleNotificationPopup() {
      const container = document.querySelector('.bi-bell-fill').closest('a');
      let popup = document.querySelector('#notificationPopup');

      if (!popup) {
        popup = document.createElement('div');
        popup.id = 'notificationPopup';
        popup.classList.add('notification-popup');
        popup.style.position = 'absolute';
        popup.style.top = '60px';
        popup.style.right = '10px';
        popup.style.backgroundColor = '#fff7d6';
        popup.style.width = '320px';
        popup.style.borderRadius = '12px';
        popup.style.boxShadow = '0 8px 20px rgba(0, 0, 0, 0.5)';
        popup.style.padding = '20px';
        popup.style.zIndex = '9999';
        popup.style.overflow = 'auto';
        popup.style.maxHeight = '400px';
        document.body.appendChild(popup);
      }

      if (popup.style.display === 'block') {
        popup.style.display = 'none';
      } else {
        popup.innerHTML = '';

        const closeBtn = document.createElement('span');
        closeBtn.innerHTML = '&times;';
        closeBtn.style.position = 'absolute';
        closeBtn.style.top = '6px';
        closeBtn.style.right = '10px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.style.fontSize = '32px';
        closeBtn.style.fontWeight = 'bold';
        closeBtn.style.zIndex = '10000';
        closeBtn.style.color = '#333';
        closeBtn.onclick = () => popup.style.display = 'none';
        popup.appendChild(closeBtn);

        fetch('/notification/list_popup')
          .then(response => response.text())
          .then(html => {
            const content = document.createElement('div');
            content.innerHTML = html;
            popup.appendChild(content);
          });

        popup.style.display = 'block';
      }
    }

    fetch('/notification/count')
      .then(response => response.text())
      .then(count => {
        const badge = document.getElementById('notificationCount');
        if (parseInt(count) > 0) {
          badge.textContent = count;
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
      });
  </script>
</div>
