<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">
<div layout:fragment="content">

  <!-- ✅ 장바구니 > 주문/결제 > 주문완료 경로 출력 -->
  <div class="cart-header-line">
    <div class="cart-title-heading">주문/결제</div>
    <div class="cart-path-box">
      <span>장바구니</span> &gt;
      <span class="cart-path-active">주문/결제</span> &gt;
      <span>주문완료</span>
    </div>
  </div>

  <form th:action="@{/order/create}" method="post" class="order-create-form">
  <!-- ✅ form이 좌우를 모두 감싸도록 유지하면서 cart 스타일 유지 -->
    <div class="order-wrapper">

      <!-- 왼쪽 입력 영역 -->
      <div class="order-container">
        <!-- 배송지 헤더 정렬 -->
        <div class="order-create-form-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h3 style="margin: 0;">배송지 정보</h3>
          <button type="button" onclick="openDeliveryModal()" class="order-create-btn">배송지 변경</button>
        </div>

        <div class="order-create-form-group"><label>수령자 이름</label><input type="text" name="rname"  id="rname" required></div>
        <div class="order-create-form-group"><label>연락처</label><input type="text" name="rtel" id="rtel" required></div>
        <div class="order-create-form-group"><label>우편번호</label><input type="text" name="rzipcode" id="rzipcode" required></div>
        <div class="order-create-form-group"><label>주소 1</label><input type="text" name="raddress1" id="raddress1" required></div>
        <div class="order-create-form-group"><label>주소 2</label><input type="text" name="raddress2" id="raddress2" required></div>
        <div class="order-create-form-group"><label>배송 메모</label><input type="text" name="message" id="message" required></div>

        <!-- 기본 배송지 저장 -->
        <div class="order-create-form-group"><label></label><button type="button" onclick="saveDefaultDelivery()" class="order-create-btn">기본 배송지로 저장</button></div>

        <!-- 결제수단 -->
        <div class="order-create-form-group"><label>결제수단</label><select name="payment"><option value="가상결제">가상결제</option><option value="무통장입금">무통장입금</option><option value="신용카드" selected>신용카드</option></select></div>

        <!-- 상품 테이블 -->
        <h3>주문 상품 목록</h3>
        <table class="order-create-table">
          <thead><tr><th>상품</th><th>수량</th><th>할인가</th><th>소계</th></tr></thead>
          <tbody>
            <tr th:each="cart : ${cartList}">
              <td><img th:src="@{|/products/storage/${cart.productsVO.thumb1}|}" width="50"><span th:text="${cart.productsVO.title}">상품명</span></td>
              <td th:text="${cart.cnt}">1</td>
              <td th:text="${#numbers.formatInteger(cart.productsVO.saleprice, 3, 'COMMA')} + '원'">할인가</td>
              <td th:text="${#numbers.formatInteger(cart.productsVO.saleprice * cart.cnt, 3, 'COMMA')} + '원'">소계</td>
            </tr>
          </tbody>
        </table>

        <!-- 히든 필드 -->
        <input type="hidden" name="total" th:value="${total}">
        <input type="hidden" name="point" value="0">
        <input type="hidden" id="deliveryno" name="deliveryno" th:value="${deliveryno != null ? deliveryno : 0}" />

    </div>

    <!-- 우측 요약 -->
    <div class="order-summary-box">
      <div class="cart-summary-title">결제 요약</div>
      <ul class="cart-summary-list">
        <li><span>총 상품금액</span><span th:text="${#numbers.formatInteger(total, 3, 'COMMA')} + '원'">0원</span></li>
        <li><span>배송비</span><span>0원</span></li>
        <li class="total"><span>결제금액</span><span th:text="${#numbers.formatInteger(total, 3, 'COMMA')} + '원'">0원</span></li>
      </ul>
      <button type="submit" class="btn-order">주문하기</button>
    </div>
  </form>

  <!-- 모달 배경 추가 -->
  <div id="deliveryBackdrop" class="order-modal-backdrop" onclick="closeDeliveryModal()"></div>

  <!-- 배송지 모달창은 폼 외부 -->
  <div class="order-modal" id="deliveryModal">
    <div class="order-modal-inner">
      <div class="order-modal-header" style="display:flex; justify-content:space-between; align-items:center;">
        <span>배송지 선택</span>
        <span onclick="closeDeliveryModal()" style="cursor:pointer; font-size:20px;">×</span>
      </div>
      <div id="deliveryList"></div>
    </div>
  </div>
  

  <!-- 스크립트 삽입 -->
  <script>
    window.addEventListener('DOMContentLoaded', function () {
      ['rname','rtel','rzipcode','raddress1','raddress2','message'].forEach(id => {
        const val = localStorage.getItem(id);
        if (val) document.getElementById(id).value = val;
      });
    });

    function openDeliveryModal() {
      fetch('/delivery/list')
        .then(res => res.json())
        .then(data => {
          const listDiv = document.getElementById("deliveryList");
          listDiv.innerHTML = data.length ? '' : '<p>등록된 배송지가 없습니다.</p>';
          
          data.forEach(d => {
            const card = document.createElement('div');
            // card.className = 'delivery-card';
            card.className = 'order-modal-card';
            card.innerHTML = `
              <strong>${d.rname}</strong><br>
              ${d.raddress1} ${d.raddress2}<br>
              ${d.rtel}<br>
              ${d.message || ''}<br><br>
              <button type="button" onclick="selectDelivery(${d.deliveryno})">선택</button>
              <button type="button" onclick="editDelivery(${d.deliveryno})">수정</button>
              <button type="button" onclick="deleteDelivery(${d.deliveryno})" class="btn btn-danger">삭제</button>
            `;
            listDiv.appendChild(card);
          });

          // 배송지 추가 버튼
          const addBtnWrapper = document.createElement('div');
          addBtnWrapper.innerHTML = `
            <button type="button" onclick="addDeliveryForm()" class="delivery-add-button">
              + 배송지 추가
            </button>
          `;
          listDiv.appendChild(addBtnWrapper);
          
          document.getElementById("deliveryModal").style.display = "block";
          document.getElementById("deliveryBackdrop").style.display = "block";
        });
    }

    function closeDeliveryModal() {
      document.getElementById("deliveryModal").style.display = "none";
      document.getElementById("deliveryBackdrop").style.display = "none";
    }

    function addDeliveryForm() {
      document.getElementById("deliveryList").innerHTML = `
        <div class="order-modal-form">
          <input type="text" id="input_rname" placeholder="이름" required>
          <input type="text" id="input_rtel" placeholder="연락처" required>
          <div style="display: flex; gap: 6px;">
            <input type="text" id="input_rzipcode" placeholder="우편번호" required style="flex:1;">
            <button type="button" class="zipcode-search-btn" onclick="loadDaumPostcodeScript(() => execDaumPostcode('input_'))">검색</button>
          </div>
          <input type="text" id="input_raddress1" placeholder="주소 1" required>
          <input type="text" id="input_raddress2" placeholder="주소 2">
          <input type="text" id="input_message" placeholder="배송 메모">
          <div class="order-modal-buttons">
            <button type="button" onclick="applyDelivery()" class="btn-add-save">저장</button>
            <button type="button" onclick="openDeliveryModal()" class="btn-add-cancel">취소</button>
          </div>
        </div>
      `;
    }


    function applyDelivery() {
      const data = {
        rname: input_rname.value, rtel: input_rtel.value,
        rzipcode: input_rzipcode.value, raddress1: input_raddress1.value,
        raddress2: input_raddress2.value, message: input_message.value
      };
      // localStorage 저장 + 본문 반영
      for (let key in data) {
        localStorage.setItem(key.replace('input_', ''), data[key]);
        document.getElementById(key.replace('input_', '')).value = data[key];
      }
      fetch('/delivery/create', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(result => {
        if (result === 'success') {
          alert('📦 배송지 저장 완료');
          openDeliveryModal();
        } else {
          alert('❌ 저장 실패');
        }
      });
    }

    function saveDefaultDelivery() {
      const deliverynoField = document.getElementById('deliveryno');
      const deliveryno = parseInt(deliverynoField?.value || 0);

      if (deliveryno === 0) {
        alert("⚠️ 배송지를 먼저 선택해주세요.");
        return;
      }

      const data = {
        deliveryno,
        rname: rname.value,
        rtel: rtel.value,
        rzipcode: rzipcode.value,
        raddress1: raddress1.value,
        raddress2: raddress2.value,
        message: message.value
      };

      console.log("✅ 기본 배송지 저장 요청 데이터:", data);

      fetch('/delivery/save_default', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(result => {
        if (result === 'success') {
          alert("✅ 기본 배송지로 저장되었습니다.");
        } else {
          alert("⚠️ 저장 중 오류 발생");
        }
      });
    }


    // 다음 주소 API 실행 - 모달 또는 본문에서 사용
    function execDaumPostcode(prefix = 'r') {
      new daum.Postcode({
        oncomplete: function(data) {
          // 각 prefix에 맞는 input ID를 찾는다 (rzipcode, raddress1, raddress2)
          const zipcodeField = document.getElementById(prefix + 'rzipcode');
          const address1Field = document.getElementById(prefix + 'raddress1');
          const address2Field = document.getElementById(prefix + 'raddress2');

          if (!zipcodeField || !address1Field || !address2Field) {
            console.warn("🚫 주소 필드를 찾을 수 없음: " + prefix);
            return;
          }

          // 우편번호 설정
          zipcodeField.value = data.zonecode;

          // 도로명 / 지번 주소 선택
          let fullAddr = (data.userSelectedType === 'R') ? data.roadAddress : data.jibunAddress;
          let extraAddr = '';

          // 추가 주소 정보 (동, 건물명)
          if (data.bname) extraAddr += data.bname;
          if (data.buildingName) {
            extraAddr += (extraAddr ? ', ' + data.buildingName : data.buildingName);
          }
          if (extraAddr) {
            fullAddr += ' (' + extraAddr + ')';
          }

          address1Field.value = fullAddr;
          address2Field.focus();
        }
      }).open();
    }

    function loadDaumPostcodeScript(callback) {
      if (typeof daum === 'undefined' || typeof daum.Postcode === 'undefined') {
        const script = document.createElement('script');
        script.src = "https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js";
        script.onload = callback;
        document.body.appendChild(script);
      } else {
        callback();
      }
    }

    // 배송지 선택 버튼 클릭 시 호출됨
    function selectDelivery(deliveryno) {
      fetch(`/delivery/read/${deliveryno}`)
        .then(res => res.json())
        .then(data => {
          // 1. 필드 반영
          document.getElementById('rname').value = data.rname;
          document.getElementById('rtel').value = data.rtel;
          document.getElementById('rzipcode').value = data.rzipcode;
          document.getElementById('raddress1').value = data.raddress1;
          document.getElementById('raddress2').value = data.raddress2;
          document.getElementById('message').value = data.message;

          // 2. localStorage 저장
          localStorage.setItem('rname', data.rname);
          localStorage.setItem('rtel', data.rtel);
          localStorage.setItem('rzipcode', data.rzipcode);
          localStorage.setItem('raddress1', data.raddress1);
          localStorage.setItem('raddress2', data.raddress2);
          localStorage.setItem('message', data.message);

          // ✅ 자동 제출 방지용: 포커스 제거 + keypress 막기
          document.activeElement.blur();

          const formEl = document.querySelector("form");
          if (formEl) {
            formEl.addEventListener("keydown", function (e) {
              if (e.key === "Enter") {
                e.preventDefault(); // 브라우저 기본 제출 막기
              }
            }, { once: true });
          }
          document.getElementById('deliveryno').value = deliveryno;

          closeDeliveryModal();
        });
    }
    // 수정 버튼 클릭 시 실행되는 함수
    function editDelivery(deliveryno) {
      fetch(`/delivery/read/${deliveryno}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("deliveryList").innerHTML = `
            <div class="order-modal-form">
              <input type="hidden" id="edit_deliveryno" value="${data.deliveryno}">
              <input type="text" id="edit_rname" placeholder="이름" value="${data.rname}" required>
              <input type="text" id="edit_rtel" placeholder="연락처" value="${data.rtel}" required>
              <div style="display: flex; gap: 10px;">
                <input type="text" id="edit_rzipcode" placeholder="우편번호" value="${data.rzipcode}" required style="flex:1;">
                <button type="button" class="zipcode-search-btn" onclick="loadDaumPostcodeScript(() => execDaumPostcode('edit_'))">검색</button>
              </div>
              <input type="text" id="edit_raddress1" placeholder="주소 1" value="${data.raddress1}" required>
              <input type="text" id="edit_raddress2" placeholder="주소 2" value="${data.raddress2}">
              <input type="text" id="edit_message" placeholder="배송 메모" value="${data.message}">
              <div class="order-modal-buttons">
                <button type="button" onclick="updateDelivery()" class="btn-add-save">수정 완료</button>
                <button type="button" onclick="openDeliveryModal()" class="btn-add-cancel">취소</button>
              </div>
            </div>`;
        });
    }


    // 수정된 내용을 서버에 반영하는 함수
    function updateDelivery() {
      const data = {
        deliveryno: parseInt(document.getElementById('edit_deliveryno').value),
        rname: document.getElementById('edit_rname').value,
        rtel: document.getElementById('edit_rtel').value,
        rzipcode: document.getElementById('edit_rzipcode').value,
        raddress1: document.getElementById('edit_raddress1').value,
        raddress2: document.getElementById('edit_raddress2').value,
        message: document.getElementById('edit_message').value
      };

      fetch('/delivery/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(result => {
        if (result === 'success') {
          alert('✏️ 수정 완료');
          openDeliveryModal(); // 다시 목록 새로고침
        } else {
          alert('❌ 수정 실패');
        }
      });
    }

    // ✅ 배송지 삭제 요청
    function deleteDelivery(deliveryno) {
      if (!confirm("정말 이 배송지를 삭제하시겠습니까?")) return;

      fetch("/delivery/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ deliveryno })
      })
      .then(res => res.text())
      .then(result => {
        if (result === 'success') {
          alert("🗑️ 삭제되었습니다.");
          openDeliveryModal();  // 삭제 후 목록 새로고침
        } else {
          alert("❌ 삭제 실패");
        }
      });
    }

    // 주문 버튼 클릭 전에 deliveryno가 설정되지 않았으면 제출을 막는다
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.querySelector("form.order-create-form");
      form.addEventListener("submit", function (e) {
        const deliveryno = document.getElementById("deliveryno").value;
        if (!deliveryno || parseInt(deliveryno) <= 0) {
          alert("⚠️ 배송지를 선택해주세요.");
          e.preventDefault(); // 제출 막음
        }
      });
    });


  </script>

</div>
</html>
