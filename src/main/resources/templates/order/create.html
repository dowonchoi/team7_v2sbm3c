<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">
<div layout:fragment="content">

  <!-- âœ… ì¥ë°”êµ¬ë‹ˆ > ì£¼ë¬¸/ê²°ì œ > ì£¼ë¬¸ì™„ë£Œ ê²½ë¡œ ì¶œë ¥ -->
  <div class="cart-header-line">
    <div class="cart-title-heading">ì£¼ë¬¸/ê²°ì œ</div>
    <div class="cart-path-box">
      <span>ì¥ë°”êµ¬ë‹ˆ</span> &gt;
      <span class="cart-path-active">ì£¼ë¬¸/ê²°ì œ</span> &gt;
      <span>ì£¼ë¬¸ì™„ë£Œ</span>
    </div>
  </div>

  <form th:action="@{/order/create}" method="post" class="order-create-form">
  <!-- âœ… formì´ ì¢Œìš°ë¥¼ ëª¨ë‘ ê°ì‹¸ë„ë¡ ìœ ì§€í•˜ë©´ì„œ cart ìŠ¤íƒ€ì¼ ìœ ì§€ -->
    <div class="order-wrapper">

      <!-- ì™¼ìª½ ì…ë ¥ ì˜ì—­ -->
      <div class="order-container">
        <!-- ë°°ì†¡ì§€ í—¤ë” ì •ë ¬ -->
        <div class="order-create-form-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h3 style="margin: 0;">ë°°ì†¡ì§€ ì •ë³´</h3>
          <button type="button" onclick="openDeliveryModal()" class="order-create-btn">ë°°ì†¡ì§€ ë³€ê²½</button>
        </div>

        <div class="order-create-form-group"><label>ìˆ˜ë ¹ì ì´ë¦„</label><input type="text" name="rname"  id="rname" required></div>
        <div class="order-create-form-group"><label>ì—°ë½ì²˜</label><input type="text" name="rtel" id="rtel" required></div>
        <div class="order-create-form-group"><label>ìš°í¸ë²ˆí˜¸</label><input type="text" name="rzipcode" id="rzipcode" required></div>
        <div class="order-create-form-group"><label>ì£¼ì†Œ 1</label><input type="text" name="raddress1" id="raddress1" required></div>
        <div class="order-create-form-group"><label>ì£¼ì†Œ 2</label><input type="text" name="raddress2" id="raddress2" required></div>
        <div class="order-create-form-group"><label>ë°°ì†¡ ë©”ëª¨</label><input type="text" name="message" id="message" required></div>

        <!-- ê¸°ë³¸ ë°°ì†¡ì§€ ì €ì¥ -->
        <div class="order-create-form-group"><label></label><button type="button" onclick="saveDefaultDelivery()" class="order-create-btn">ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì €ì¥</button></div>

        <!-- ê²°ì œìˆ˜ë‹¨ -->
        <div class="order-create-form-group"><label>ê²°ì œìˆ˜ë‹¨</label><select name="payment"><option value="ê°€ìƒê²°ì œ">ê°€ìƒê²°ì œ</option><option value="ë¬´í†µì¥ì…ê¸ˆ">ë¬´í†µì¥ì…ê¸ˆ</option><option value="ì‹ ìš©ì¹´ë“œ" selected>ì‹ ìš©ì¹´ë“œ</option></select></div>

        <!-- ìƒí’ˆ í…Œì´ë¸” -->
        <h3>ì£¼ë¬¸ ìƒí’ˆ ëª©ë¡</h3>
        <table class="order-create-table">
          <thead><tr><th>ìƒí’ˆ</th><th>ìˆ˜ëŸ‰</th><th>í• ì¸ê°€</th><th>ì†Œê³„</th></tr></thead>
          <tbody>
            <tr th:each="cart : ${cartList}">
              <td><img th:src="@{|/products/storage/${cart.productsVO.thumb1}|}" width="50"><span th:text="${cart.productsVO.title}">ìƒí’ˆëª…</span></td>
              <td th:text="${cart.cnt}">1</td>
              <td th:text="${#numbers.formatInteger(cart.productsVO.saleprice, 3, 'COMMA')} + 'ì›'">í• ì¸ê°€</td>
              <td th:text="${#numbers.formatInteger(cart.productsVO.saleprice * cart.cnt, 3, 'COMMA')} + 'ì›'">ì†Œê³„</td>
            </tr>
          </tbody>
        </table>

        <!-- íˆë“  í•„ë“œ -->
        <input type="hidden" name="total" th:value="${total}">
        <input type="hidden" name="point" value="0">
        <input type="hidden" id="deliveryno" name="deliveryno" th:value="${deliveryno != null ? deliveryno : 0}" />

    </div>

    <!-- ìš°ì¸¡ ìš”ì•½ -->
    <div class="order-summary-box">
      <div class="cart-summary-title">ê²°ì œ ìš”ì•½</div>
      <ul class="cart-summary-list">
        <li><span>ì´ ìƒí’ˆê¸ˆì•¡</span><span th:text="${#numbers.formatInteger(total, 3, 'COMMA')} + 'ì›'">0ì›</span></li>
        <li><span>ë°°ì†¡ë¹„</span><span>0ì›</span></li>
        <li class="total"><span>ê²°ì œê¸ˆì•¡</span><span th:text="${#numbers.formatInteger(total, 3, 'COMMA')} + 'ì›'">0ì›</span></li>
      </ul>
      <button type="submit" class="btn-order">ì£¼ë¬¸í•˜ê¸°</button>
    </div>
  </form>

  <!-- ëª¨ë‹¬ ë°°ê²½ ì¶”ê°€ -->
  <div id="deliveryBackdrop" class="order-modal-backdrop" onclick="closeDeliveryModal()"></div>

  <!-- ë°°ì†¡ì§€ ëª¨ë‹¬ì°½ì€ í¼ ì™¸ë¶€ -->
  <div class="order-modal" id="deliveryModal">
    <div class="order-modal-inner">
      <div class="order-modal-header" style="display:flex; justify-content:space-between; align-items:center;">
        <span>ë°°ì†¡ì§€ ì„ íƒ</span>
        <span onclick="closeDeliveryModal()" style="cursor:pointer; font-size:20px;">Ã—</span>
      </div>
      <div id="deliveryList"></div>
    </div>
  </div>
  

  <!-- ìŠ¤í¬ë¦½íŠ¸ ì‚½ì… -->
  <script>
    window.addEventListener('DOMContentLoaded', function () {
      ['rname','rtel','rzipcode','raddress1','raddress2','message'].forEach(id => {
        const val = localStorage.getItem(id);
        if (val) document.getElementById(id).value = val;
      });
    });

    function openDeliveryModal() {
      fetch('/delivery/list')
        .then(res => res.json())
        .then(data => {
          const listDiv = document.getElementById("deliveryList");
          listDiv.innerHTML = data.length ? '' : '<p>ë“±ë¡ëœ ë°°ì†¡ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          
          data.forEach(d => {
            const card = document.createElement('div');
            // card.className = 'delivery-card';
            card.className = 'order-modal-card';
            card.innerHTML = `
              <strong>${d.rname}</strong><br>
              ${d.raddress1} ${d.raddress2}<br>
              ${d.rtel}<br>
              ${d.message || ''}<br><br>
              <button type="button" onclick="selectDelivery(${d.deliveryno})">ì„ íƒ</button>
              <button type="button" onclick="editDelivery(${d.deliveryno})">ìˆ˜ì •</button>
              <button type="button" onclick="deleteDelivery(${d.deliveryno})" class="btn btn-danger">ì‚­ì œ</button>
            `;
            listDiv.appendChild(card);
          });

          // ë°°ì†¡ì§€ ì¶”ê°€ ë²„íŠ¼
          const addBtnWrapper = document.createElement('div');
          addBtnWrapper.innerHTML = `
            <button type="button" onclick="addDeliveryForm()" class="delivery-add-button">
              + ë°°ì†¡ì§€ ì¶”ê°€
            </button>
          `;
          listDiv.appendChild(addBtnWrapper);
          
          document.getElementById("deliveryModal").style.display = "block";
          document.getElementById("deliveryBackdrop").style.display = "block";
        });
    }

    function closeDeliveryModal() {
      document.getElementById("deliveryModal").style.display = "none";
      document.getElementById("deliveryBackdrop").style.display = "none";
    }

    function addDeliveryForm() {
      document.getElementById("deliveryList").innerHTML = `
        <div class="order-modal-form">
          <input type="text" id="input_rname" placeholder="ì´ë¦„" required>
          <input type="text" id="input_rtel" placeholder="ì—°ë½ì²˜" required>
          <div style="display: flex; gap: 6px;">
            <input type="text" id="input_rzipcode" placeholder="ìš°í¸ë²ˆí˜¸" required style="flex:1;">
            <button type="button" class="zipcode-search-btn" onclick="loadDaumPostcodeScript(() => execDaumPostcode('input_'))">ê²€ìƒ‰</button>
          </div>
          <input type="text" id="input_raddress1" placeholder="ì£¼ì†Œ 1" required>
          <input type="text" id="input_raddress2" placeholder="ì£¼ì†Œ 2">
          <input type="text" id="input_message" placeholder="ë°°ì†¡ ë©”ëª¨">
          <div class="order-modal-buttons">
            <button type="button" onclick="applyDelivery()" class="btn-add-save">ì €ì¥</button>
            <button type="button" onclick="openDeliveryModal()" class="btn-add-cancel">ì·¨ì†Œ</button>
          </div>
        </div>
      `;
    }


    function applyDelivery() {
      const data = {
        rname: input_rname.value, rtel: input_rtel.value,
        rzipcode: input_rzipcode.value, raddress1: input_raddress1.value,
        raddress2: input_raddress2.value, message: input_message.value
      };
      // localStorage ì €ì¥ + ë³¸ë¬¸ ë°˜ì˜
      for (let key in data) {
        localStorage.setItem(key.replace('input_', ''), data[key]);
        document.getElementById(key.replace('input_', '')).value = data[key];
      }
      fetch('/delivery/create', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(result => {
        if (result === 'success') {
          alert('ğŸ“¦ ë°°ì†¡ì§€ ì €ì¥ ì™„ë£Œ');
          openDeliveryModal();
        } else {
          alert('âŒ ì €ì¥ ì‹¤íŒ¨');
        }
      });
    }

    function saveDefaultDelivery() {
      const deliverynoField = document.getElementById('deliveryno');
      const deliveryno = parseInt(deliverynoField?.value || 0);

      if (deliveryno === 0) {
        alert("âš ï¸ ë°°ì†¡ì§€ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      const data = {
        deliveryno,
        rname: rname.value,
        rtel: rtel.value,
        rzipcode: rzipcode.value,
        raddress1: raddress1.value,
        raddress2: raddress2.value,
        message: message.value
      };

      console.log("âœ… ê¸°ë³¸ ë°°ì†¡ì§€ ì €ì¥ ìš”ì²­ ë°ì´í„°:", data);

      fetch('/delivery/save_default', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(result => {
        if (result === 'success') {
          alert("âœ… ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          alert("âš ï¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        }
      });
    }


    // ë‹¤ìŒ ì£¼ì†Œ API ì‹¤í–‰ - ëª¨ë‹¬ ë˜ëŠ” ë³¸ë¬¸ì—ì„œ ì‚¬ìš©
    function execDaumPostcode(prefix = 'r') {
      new daum.Postcode({
        oncomplete: function(data) {
          // ê° prefixì— ë§ëŠ” input IDë¥¼ ì°¾ëŠ”ë‹¤ (rzipcode, raddress1, raddress2)
          const zipcodeField = document.getElementById(prefix + 'rzipcode');
          const address1Field = document.getElementById(prefix + 'raddress1');
          const address2Field = document.getElementById(prefix + 'raddress2');

          if (!zipcodeField || !address1Field || !address2Field) {
            console.warn("ğŸš« ì£¼ì†Œ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: " + prefix);
            return;
          }

          // ìš°í¸ë²ˆí˜¸ ì„¤ì •
          zipcodeField.value = data.zonecode;

          // ë„ë¡œëª… / ì§€ë²ˆ ì£¼ì†Œ ì„ íƒ
          let fullAddr = (data.userSelectedType === 'R') ? data.roadAddress : data.jibunAddress;
          let extraAddr = '';

          // ì¶”ê°€ ì£¼ì†Œ ì •ë³´ (ë™, ê±´ë¬¼ëª…)
          if (data.bname) extraAddr += data.bname;
          if (data.buildingName) {
            extraAddr += (extraAddr ? ', ' + data.buildingName : data.buildingName);
          }
          if (extraAddr) {
            fullAddr += ' (' + extraAddr + ')';
          }

          address1Field.value = fullAddr;
          address2Field.focus();
        }
      }).open();
    }

    function loadDaumPostcodeScript(callback) {
      if (typeof daum === 'undefined' || typeof daum.Postcode === 'undefined') {
        const script = document.createElement('script');
        script.src = "https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js";
        script.onload = callback;
        document.body.appendChild(script);
      } else {
        callback();
      }
    }

    // ë°°ì†¡ì§€ ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë¨
    function selectDelivery(deliveryno) {
      fetch(`/delivery/read/${deliveryno}`)
        .then(res => res.json())
        .then(data => {
          // 1. í•„ë“œ ë°˜ì˜
          document.getElementById('rname').value = data.rname;
          document.getElementById('rtel').value = data.rtel;
          document.getElementById('rzipcode').value = data.rzipcode;
          document.getElementById('raddress1').value = data.raddress1;
          document.getElementById('raddress2').value = data.raddress2;
          document.getElementById('message').value = data.message;

          // 2. localStorage ì €ì¥
          localStorage.setItem('rname', data.rname);
          localStorage.setItem('rtel', data.rtel);
          localStorage.setItem('rzipcode', data.rzipcode);
          localStorage.setItem('raddress1', data.raddress1);
          localStorage.setItem('raddress2', data.raddress2);
          localStorage.setItem('message', data.message);

          // âœ… ìë™ ì œì¶œ ë°©ì§€ìš©: í¬ì»¤ìŠ¤ ì œê±° + keypress ë§‰ê¸°
          document.activeElement.blur();

          const formEl = document.querySelector("form");
          if (formEl) {
            formEl.addEventListener("keydown", function (e) {
              if (e.key === "Enter") {
                e.preventDefault(); // ë¸Œë¼ìš°ì € ê¸°ë³¸ ì œì¶œ ë§‰ê¸°
              }
            }, { once: true });
          }
          document.getElementById('deliveryno').value = deliveryno;

          closeDeliveryModal();
        });
    }
    // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
    function editDelivery(deliveryno) {
      fetch(`/delivery/read/${deliveryno}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("deliveryList").innerHTML = `
            <div class="order-modal-form">
              <input type="hidden" id="edit_deliveryno" value="${data.deliveryno}">
              <input type="text" id="edit_rname" placeholder="ì´ë¦„" value="${data.rname}" required>
              <input type="text" id="edit_rtel" placeholder="ì—°ë½ì²˜" value="${data.rtel}" required>
              <div style="display: flex; gap: 10px;">
                <input type="text" id="edit_rzipcode" placeholder="ìš°í¸ë²ˆí˜¸" value="${data.rzipcode}" required style="flex:1;">
                <button type="button" class="zipcode-search-btn" onclick="loadDaumPostcodeScript(() => execDaumPostcode('edit_'))">ê²€ìƒ‰</button>
              </div>
              <input type="text" id="edit_raddress1" placeholder="ì£¼ì†Œ 1" value="${data.raddress1}" required>
              <input type="text" id="edit_raddress2" placeholder="ì£¼ì†Œ 2" value="${data.raddress2}">
              <input type="text" id="edit_message" placeholder="ë°°ì†¡ ë©”ëª¨" value="${data.message}">
              <div class="order-modal-buttons">
                <button type="button" onclick="updateDelivery()" class="btn-add-save">ìˆ˜ì • ì™„ë£Œ</button>
                <button type="button" onclick="openDeliveryModal()" class="btn-add-cancel">ì·¨ì†Œ</button>
              </div>
            </div>`;
        });
    }


    // ìˆ˜ì •ëœ ë‚´ìš©ì„ ì„œë²„ì— ë°˜ì˜í•˜ëŠ” í•¨ìˆ˜
    function updateDelivery() {
      const data = {
        deliveryno: parseInt(document.getElementById('edit_deliveryno').value),
        rname: document.getElementById('edit_rname').value,
        rtel: document.getElementById('edit_rtel').value,
        rzipcode: document.getElementById('edit_rzipcode').value,
        raddress1: document.getElementById('edit_raddress1').value,
        raddress2: document.getElementById('edit_raddress2').value,
        message: document.getElementById('edit_message').value
      };

      fetch('/delivery/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(result => {
        if (result === 'success') {
          alert('âœï¸ ìˆ˜ì • ì™„ë£Œ');
          openDeliveryModal(); // ë‹¤ì‹œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
          alert('âŒ ìˆ˜ì • ì‹¤íŒ¨');
        }
      });
    }

    // âœ… ë°°ì†¡ì§€ ì‚­ì œ ìš”ì²­
    function deleteDelivery(deliveryno) {
      if (!confirm("ì •ë§ ì´ ë°°ì†¡ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      fetch("/delivery/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ deliveryno })
      })
      .then(res => res.text())
      .then(result => {
        if (result === 'success') {
          alert("ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          openDeliveryModal();  // ì‚­ì œ í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
          alert("âŒ ì‚­ì œ ì‹¤íŒ¨");
        }
      });
    }

    // ì£¼ë¬¸ ë²„íŠ¼ í´ë¦­ ì „ì— deliverynoê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì œì¶œì„ ë§‰ëŠ”ë‹¤
    document.addEventListener("DOMContentLoaded", function () {
      const form = document.querySelector("form.order-create-form");
      form.addEventListener("submit", function (e) {
        const deliveryno = document.getElementById("deliveryno").value;
        if (!deliveryno || parseInt(deliveryno) <= 0) {
          alert("âš ï¸ ë°°ì†¡ì§€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          e.preventDefault(); // ì œì¶œ ë§‰ìŒ
        }
      });
    });


  </script>

</div>
</html>
