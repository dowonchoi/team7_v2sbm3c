<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">
<div layout:fragment="content">
  <h2>ì£¼ë¬¸/ê²°ì œ</h2>
    <form th:action="@{/order/create}" method="post">

    <!-- ë°°ì†¡ì§€ ë³€ê²½ ë²„íŠ¼ -->
    <button type="button" onclick="openDeliveryModal()" class="btn btn-primary" style="float: right;">ë°°ì†¡ì§€ ë³€ê²½</button>
    
    <!-- ìˆ˜ë ¹ì ì •ë³´ -->
    <div><label>ìˆ˜ë ¹ì ì´ë¦„</label>
      <input type="text" name="rname"  id="rname" required>
    </div>

    <div><label>ì—°ë½ì²˜</label>
      <input type="text" name="rtel" id="rtel" required>
    </div>

    <div><label>ìš°í¸ë²ˆí˜¸</label>
      <input type="text" name="rzipcode" id="rzipcode" required>
      <!-- ê²€ìƒ‰ ë²„íŠ¼ -->
      <button type="button" onclick="loadDaumPostcodeScript(() => execDaumPostcode('r'))">ê²€ìƒ‰</button>
    </div>

    <div><label>ì£¼ì†Œ 1</label>
      <input type="text" name="raddress1" id="raddress1" required>
    </div>

    <div><label>ì£¼ì†Œ 2</label>
      <input type="text" name="raddress2" id="raddress2" required>
    </div>

    <div><label>ë°°ì†¡ ë©”ëª¨</label>
      <input type="text" name="message" id="message" required>
    </div>

    <!-- ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì €ì¥ ë²„íŠ¼ -->
    <button type="button" onclick="saveDefaultDelivery()">ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì €ì¥</button>


    <!-- ê²°ì œ ìˆ˜ë‹¨ -->
    <div><label>ê²°ì œìˆ˜ë‹¨</label>
      <select name="payment">
        <option value="ê°€ìƒê²°ì œ">ê°€ìƒê²°ì œ</option>
        <option value="ë¬´í†µì¥ì…ê¸ˆ">ë¬´í†µì¥ì…ê¸ˆ</option>
        <option value="ì‹ ìš©ì¹´ë“œ" selected>ì‹ ìš©ì¹´ë“œ</option>
      </select>
    </div>

    <!-- ì¥ë°”êµ¬ë‹ˆ ì„ íƒ í•­ëª© ëª©ë¡ ì¶œë ¥ -->
    <h3>ì£¼ë¬¸ ìƒí’ˆ ëª©ë¡</h3>
    <table>
      <thead>
        <tr>
          <th>ìƒí’ˆ</th>
          <th>ìˆ˜ëŸ‰</th>
          <th>í• ì¸ê°€</th>
          <th>ì†Œê³„</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="cart : ${cartList}">
          <td>
            <img th:src="@{|/products/storage/${cart.productsVO.thumb1}|}" width="50">
            <span th:text="${cart.productsVO.title}">ìƒí’ˆëª…</span>
          </td>
          <td th:text="${cart.cnt}">1</td>
          <td th:text="${#numbers.formatInteger(cart.productsVO.saleprice, 3, 'COMMA')} + 'ì›'">í• ì¸ê°€</td>
          <td th:text="${#numbers.formatInteger(cart.productsVO.saleprice * cart.cnt, 3, 'COMMA')} + 'ì›'">ì†Œê³„</td>
        </tr>
      </tbody>
    </table>

    <!-- ì´ ê¸ˆì•¡ ë° í¬ì¸íŠ¸ ì¶œë ¥ -->
    <div><strong>ì´ ê²°ì œ ê¸ˆì•¡: </strong>
      <span th:text="${#numbers.formatInteger(total, 3, 'COMMA')} + 'ì›'">0ì›</span>
    </div>
    <input type="hidden" name="total" th:value="${total}">
    <input type="hidden" name="point" value="0"><!-- í–¥í›„ í¬ì¸íŠ¸ ì ë¦½ ê³„ì‚° ê°€ëŠ¥ -->

    <!-- ì£¼ë¬¸í•˜ê¸° ë²„íŠ¼ -->
    <div>
      <button type="submit">ì£¼ë¬¸í•˜ê¸°</button>
    </div>

    <!-- ë°°ì†¡ì§€ ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ì°½ -->
    <div id="deliveryModal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%);
        background:white; border:2px solid #ccc; padding:20px; z-index:999; width:420px; max-height:80%; overflow-y:auto; box-shadow: 0 5px 15px rgba(0,0,0,0.3);">
      <h3>ë°°ì†¡ì§€ ì„ íƒ</h3>
      <div id="deliveryList">
        <!-- JSë¡œ ë°°ì†¡ì§€ ì¹´ë“œ ë°˜ë³µ ì‚½ì… ì˜ˆì • -->
      </div>
      <button type="button" onclick="addDeliveryForm()">+ ë°°ì†¡ì§€ ì¶”ê°€</button>
      <button type="button" onclick="closeDeliveryModal()">ë‹«ê¸°</button>
    </div>

  </form>

  <!-- ìŠ¤í¬ë¦½íŠ¸ ì‚½ì… -->
  <script>
    window.addEventListener('DOMContentLoaded', function () {
      ['rname','rtel','rzipcode','raddress1','raddress2','message'].forEach(id => {
        const val = localStorage.getItem(id);
        if (val) document.getElementById(id).value = val;
      });
    });

    function openDeliveryModal() {
      fetch('/delivery/list')
        .then(res => res.json())
        .then(data => {
          const listDiv = document.getElementById("deliveryList");
          listDiv.innerHTML = data.length ? '' : '<p>ë“±ë¡ëœ ë°°ì†¡ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
          data.forEach(d => {
            const card = document.createElement('div');
            card.className = 'delivery-card';
            card.style.border = '1px solid #ddd';
            card.style.padding = '10px';
            card.style.marginBottom = '10px';
            card.innerHTML = `
              <strong>${d.rname}</strong><br>
              ${d.raddress1} ${d.raddress2}<br>
              ${d.rtel}<br>
              ${d.message || ''}<br><br>
              <button onclick="selectDelivery(${d.deliveryno})">ì„ íƒ</button>
              <button onclick="editDelivery(${d.deliveryno})">ìˆ˜ì •</button>`;
            listDiv.appendChild(card);
          });
          document.getElementById("deliveryModal").style.display = "block";
        });
    }

    function closeDeliveryModal() {
      document.getElementById("deliveryModal").style.display = "none";
    }

    function addDeliveryForm() {
      document.getElementById("deliveryList").innerHTML = `
        <div style="display:flex; flex-direction:column; gap:6px;">
          <input type="text" id="input_rname" placeholder="ì´ë¦„" required>
          <input type="text" id="input_rtel" placeholder="ì—°ë½ì²˜" required>
          <div>
            <input type="text" id="input_rzipcode" placeholder="ìš°í¸ë²ˆí˜¸" required style="width:65%;">
            <button type="button" onclick="loadDaumPostcodeScript(() => execDaumPostcode('input_'))">ê²€ìƒ‰</button>
          </div>
          <input type="text" id="input_raddress1" placeholder="ì£¼ì†Œ 1" required>
          <input type="text" id="input_raddress2" placeholder="ì£¼ì†Œ 2">
          <input type="text" id="input_message" placeholder="ë°°ì†¡ ë©”ëª¨">
          <button type="button" onclick="applyDelivery()" class="btn btn-success">ì €ì¥</button>
          <button type="button" onclick="openDeliveryModal()" class="btn btn-secondary">ì·¨ì†Œ</button>
        </div>`;
    }

    function applyDelivery() {
      const data = {
        rname: input_rname.value, rtel: input_rtel.value,
        rzipcode: input_rzipcode.value, raddress1: input_raddress1.value,
        raddress2: input_raddress2.value, message: input_message.value
      };
      // localStorage ì €ì¥ + ë³¸ë¬¸ ë°˜ì˜
      for (let key in data) {
        localStorage.setItem(key.replace('input_', ''), data[key]);
        document.getElementById(key.replace('input_', '')).value = data[key];
      }
      fetch('/delivery/create', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(result => {
        if (result === 'success') {
          alert('ğŸ“¦ ë°°ì†¡ì§€ ì €ì¥ ì™„ë£Œ');
          openDeliveryModal();
        } else {
          alert('âŒ ì €ì¥ ì‹¤íŒ¨');
        }
      });
    }

    function saveDefaultDelivery() {
      const data = {
        rname: rname.value, rtel: rtel.value, rzipcode: rzipcode.value,
        raddress1: raddress1.value, raddress2: raddress2.value,
        message: message.value
      };
      fetch('/delivery/save_default', {
        method: 'POST', headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      })
      .then(res => res.text())
      .then(result => {
        if (result === 'success') {
          alert("âœ… ê¸°ë³¸ ë°°ì†¡ì§€ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else if (result === 'not_logged_in') {
          alert("â— ë¡œê·¸ì¸ í›„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.");
          location.href = "/member/login";
        } else {
          alert("âš ï¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
        }
      });
    }

    // ë‹¤ìŒ ì£¼ì†Œ API ì‹¤í–‰ - ëª¨ë‹¬ ë˜ëŠ” ë³¸ë¬¸ì—ì„œ ì‚¬ìš©
    function execDaumPostcode(prefix = 'r') {
      new daum.Postcode({
        oncomplete: function(data) {
          // ê° prefixì— ë§ëŠ” input IDë¥¼ ì°¾ëŠ”ë‹¤ (rzipcode, raddress1, raddress2)
          const zipcodeField = document.getElementById(prefix + 'rzipcode');
          const address1Field = document.getElementById(prefix + 'raddress1');
          const address2Field = document.getElementById(prefix + 'raddress2');

          if (!zipcodeField || !address1Field || !address2Field) {
            console.warn("ğŸš« ì£¼ì†Œ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: " + prefix);
            return;
          }

          // ìš°í¸ë²ˆí˜¸ ì„¤ì •
          zipcodeField.value = data.zonecode;

          // ë„ë¡œëª… / ì§€ë²ˆ ì£¼ì†Œ ì„ íƒ
          let fullAddr = (data.userSelectedType === 'R') ? data.roadAddress : data.jibunAddress;
          let extraAddr = '';

          // ì¶”ê°€ ì£¼ì†Œ ì •ë³´ (ë™, ê±´ë¬¼ëª…)
          if (data.bname) extraAddr += data.bname;
          if (data.buildingName) {
            extraAddr += (extraAddr ? ', ' + data.buildingName : data.buildingName);
          }
          if (extraAddr) {
            fullAddr += ' (' + extraAddr + ')';
          }

          address1Field.value = fullAddr;
          address2Field.focus();
        }
      }).open();
    }

    function loadDaumPostcodeScript(callback) {
      if (typeof daum === 'undefined' || typeof daum.Postcode === 'undefined') {
        const script = document.createElement('script');
        script.src = "https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js";
        script.onload = callback;
        document.body.appendChild(script);
      } else {
        callback();
      }
    }

    // ë°°ì†¡ì§€ ì„ íƒ ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œë¨
    function selectDelivery(deliveryno) {
      fetch(`/delivery/read/${deliveryno}`)
        .then(res => res.json())
        .then(data => {
          // 1. localStorageì— ì €ì¥ (ì¶”í›„ ìƒˆë¡œê³ ì¹¨ì—ë„ ìœ ì§€ë¨)
          localStorage.setItem('rname', data.rname);
          localStorage.setItem('rtel', data.rtel);
          localStorage.setItem('rzipcode', data.rzipcode);
          localStorage.setItem('raddress1', data.raddress1);
          localStorage.setItem('raddress2', data.raddress2);
          localStorage.setItem('message', data.message);

          // 2. ë³¸ë¬¸ ì…ë ¥ í•„ë“œì— ì§ì ‘ ë°˜ì˜
          document.getElementById('rname').value = data.rname;
          document.getElementById('rtel').value = data.rtel;
          document.getElementById('rzipcode').value = data.rzipcode;
          document.getElementById('raddress1').value = data.raddress1;
          document.getElementById('raddress2').value = data.raddress2;
          document.getElementById('message').value = data.message;

          // 3. ëª¨ë‹¬ ë‹«ê¸°
          closeDeliveryModal();
        })
        .catch(err => {
          console.error("ğŸš« ë°°ì†¡ì§€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", err);
          alert("ë°°ì†¡ì§€ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        });
    }


  </script>

</div>
</html>
