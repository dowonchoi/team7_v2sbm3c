<!DOCTYPE html>
<html layout:decorate="~{layout}">
<div layout:fragment="content">

<link rel="stylesheet" href="/css/list_calendar.css">

<script>
function changeMonth(cnt) {
  const monthTitle = document.getElementById('month_title');
  let currentYear = parseInt(monthTitle.getAttribute('data-current_year'));
  let currentMonth = parseInt(monthTitle.getAttribute('data-current_month'));

  currentMonth += cnt;
  if (currentMonth > 11) {
    currentMonth = 0;
    currentYear++;
  } else if (currentMonth < 0) {
    currentMonth = 11;
    currentYear--;
  }

  const url = `/calendar/list_calendar?year=${currentYear}&month=${currentMonth + 1}`;
  location.href = url;
}

async function fetchCalendarData(year, month) {
  try {
    const response = await fetch(`/calendar/list_calendar_range?month=${year}-${String(month).padStart(2, '0')}`);
    if (!response.ok) throw new Error("Network error");

    const data = await response.json();

    const dayCells = Array.from(document.querySelectorAll("td[data-date]"));
    const cellMap = {};
    dayCells.forEach(cell => {
      const date = cell.getAttribute("data-date");
      cellMap[date] = cell;
    });

    data.forEach(item => {
      const start = new Date(item.startdate);
      const end = new Date(item.enddate);

      const startStr = `${start.getFullYear()}-${String(start.getMonth() + 1).padStart(2, '0')}-${String(start.getDate()).padStart(2, '0')}`;
      const endStr = `${end.getFullYear()}-${String(end.getMonth() + 1).padStart(2, '0')}-${String(end.getDate()).padStart(2, '0')}`;

      const startCell = cellMap[startStr];
      const endCell = cellMap[endStr];

      const labelClass = (item.grade <= 4) ? "event-admin"
                        : (item.grade <= 15) ? "event-supplier"
                        : "event-user";

      if (startCell) {
        const label = document.createElement("div");
        label.innerHTML = `<a href='/calendar/read/${item.calendarno}'>${item.title}</a>`;
        label.classList.add("event-label", labelClass);
        startCell.appendChild(label);
      }

      if (endCell && endStr !== startStr) {
        const label = document.createElement("div");
        label.innerHTML = `<a href='/calendar/read/${item.calendarno}'>${item.title}</a>`;
        label.classList.add("event-label", labelClass);
        endCell.appendChild(label);
      }
    });
  } catch (error) {
    console.error("Error:", error);
  }
}

window.onload = function() {
  const year = parseInt('[[${year}]]');
  const month = parseInt('[[${month}]]');

  const monthTitle = document.getElementById('month_title');
  monthTitle.setAttribute('data-current_year', year);
  monthTitle.setAttribute('data-current_month', month);

  const panel_year_month = document.getElementById("panel_year_month");
  panel_year_month.innerHTML = `${year}년 ${month + 1}월`;

  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const calendarBody = document.querySelector("tbody");
  calendarBody.innerHTML = "";

  const firstDay = new Date(year, month, 1).getDay();
  let row = document.createElement("tr");

  for (let i = 0; i < firstDay; i++) {
    const emptyCell = document.createElement("td");
    row.appendChild(emptyCell);
  }

  for (let day = 1; day <= daysInMonth; day++) {
    const cell = document.createElement("td");
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    cell.setAttribute("data-date", dateStr);

    const dateLabel = document.createElement("div");
    dateLabel.classList.add("date-label");
    dateLabel.innerText = day;
    cell.appendChild(dateLabel);

    row.appendChild(cell);

    if ((firstDay + day) % 7 === 0) {
      calendarBody.appendChild(row);
      row = document.createElement("tr");
    }
  }

  if (row.children.length > 0 && row.children.length < 7) {
    while (row.children.length < 7) {
      const emptyCell = document.createElement("td");
      row.appendChild(emptyCell);
    }
    calendarBody.appendChild(row);
  }

  fetchCalendarData(year, month + 1);
};
</script>

<div id="calendar_top">
  <div id="calendar_center">
    <h4 id="month_title" data-current_year="" data-current_month="">
      <a href="javascript:changeMonth(-1)">◀</a>
      <span id="panel_year_month"></span>
      <a href="javascript:changeMonth(1)">▶</a>
    </h4>
  </div>
  <div id="calendar_menu">
    <a href="/calendar/create">일정 등록</a>
    <a href="/calendar/list_all">전체 목록</a>
  </div>
</div>

<table>
  <thead>
    <tr>
      <th class="weekend">일</th>
      <th>월</th>
      <th>화</th>
      <th>수</th>
      <th>목</th>
      <th>금</th>
      <th class="saturday">토</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

</div>
</html>
