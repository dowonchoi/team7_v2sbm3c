<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">
<div layout:fragment="content">

  <!-- 경로만 우측에 띄우기 위해 별도 wrapper 추가 -->
  <div class="cart-header-line">
    <div class="cart-title-heading">장바구니 목록</div>
    <div class="cart-path-box">
      <span class="cart-path-active">장바구니</span> &gt;
      <span>주문/결제</span> &gt;
      <span>주문완료</span>
    </div>
  </div>

  <!-- 전체 wrapper -->
  <div class="cart-wrapper">
    <div class="cart-container">
      <div class="cart-item" th:each="cart : ${list}">
        <input type="checkbox" th:checked="${cart.selected == 'Y'}"
              th:attr="data-cartno=${cart.cartno}"
              onchange="updateSelected(this)"
              class="cart-checkbox">

        <img th:src="@{|/products/storage/${cart.productsVO.thumb1}|}" class="cart-thumb">

        <div class="cart-info-box">
          <div class="cart-info-header">
            <div class="cart-title" th:text="${cart.productsVO.title}">상품명</div>
            <form th:action="@{/cart/delete}" method="post">
              <input type="hidden" name="cartno" th:value="${cart.cartno}" />
              <button type="submit" class="cart-delete-btn">삭제</button>
            </form>
          </div>

          <div class="cart-delivery">내일(월) 도착 보장</div>

          <div class="cart-price" th:text="${#numbers.formatInteger(cart.productsVO.saleprice, 3, 'COMMA')} + '원'">0원</div>

          <div class="cart-qty">
            <button type="button"
                    th:attr="onclick=|changeCnt(${cart.cartno}, -1)|">-</button>
            <input type="text"
                  th:id="'cnt_' + ${cart.cartno}"
                  th:value="${cart.cnt}"
                  readonly>
            <button type="button"
                    th:attr="onclick=|changeCnt(${cart.cartno}, 1)|">+</button>
          </div>

          <div class="cart-subtotal"
              th:id="'subtotal_' + ${cart.cartno}"
              th:attr="data-unitprice=${cart.productsVO.saleprice}"
              th:text="${#numbers.formatInteger(cart.productsVO.saleprice * cart.cnt, 3, 'COMMA')} + '원'">
          </div>
        </div>
      </div>
    </div>

    <div class="cart-summary-box">
      <div class="cart-summary-title">주문 예상 금액</div>

      <ul class="cart-summary-list">
        <li><span>총 상품 가격</span><span>0원</span></li>
        <li><span>총 할인</span><span class="red">-0원</span></li>
        <li><span>총 배송비</span><span>+0원</span></li>
        <li class="total"><span>합계</span><span id="total_price"
            th:attr="data-total=${total}"
            th:text="${#numbers.formatInteger(total, 3, 'COMMA')} + '원'">0원</span></li>
      </ul>

      <form th:action="@{/order/form}" method="get">
        <button type="submit" class="btn-order">구매하기 (0)</button>
      </form>

      <form th:action="@{/cart/delete_all}" method="post" style="margin-top: 10px;">
        <button type="submit" class="btn-delete-all">전체 삭제</button>
      </form>
    </div>
  </div>


  <script>
  function changeCnt(cartno, delta) {
    const cntInput = document.getElementById("cnt_" + cartno);
    let cnt = parseInt(cntInput.value);
    cnt += delta;
    if (cnt < 1) return;

    fetch('/cart/update_cnt', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        cartno: cartno,
        cnt: cnt
      })
    })
    .then(response => {
      if (response.ok) {
        cntInput.value = cnt;

        // 단가 추출 → 합계 계산
        const subtotalEl = document.getElementById("subtotal_" + cartno);
        const unitPrice = parseInt(subtotalEl.dataset.unitprice);
        const subtotal = unitPrice * cnt;
        subtotalEl.innerText = subtotal.toLocaleString() + '원';

        // 총합 재계산
        updateTotalPrice();
      } else {
        alert("수량 변경 실패");
      }
    });
  }

  function updateTotalPrice() {
    let total = 0;
    document.querySelectorAll('[id^="subtotal_"]').forEach(el => {
      const unitPrice = parseInt(el.dataset.unitprice);
      const cntId = 'cnt_' + el.id.split('_')[1];
      const cnt = parseInt(document.getElementById(cntId).value);
      total += unitPrice * cnt;
    });

    document.getElementById("total_price").innerText = total.toLocaleString() + '원';
  }
  </script>

  <script>
  function updateSelected(checkbox) {
    const cartno = checkbox.getAttribute('data-cartno');
    const selected = checkbox.checked ? 'Y' : 'N';

    fetch('/cart/update_selected', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ cartno, selected })
    })
    .then(response => response.text())
    .then(result => {
      if (result !== 'success') {
        alert('선택 상태 변경 실패');
        checkbox.checked = !checkbox.checked; // 롤백
      }
    })
    .catch(error => {
      alert('오류 발생');
      checkbox.checked = !checkbox.checked; // 롤백
    });
  }
  </script>




</div>
</html>
