<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">
<div layout:fragment="content">

  <h2>장바구니 목록</h2>

  <table class="table table-bordered" style="width:100%;">
    <thead>
      <tr>
        <th>상품</th>
        <th>수량</th>
        <th>단가</th>
        <th>합계</th>
        <th>삭제</th>
      </tr>
    </thead>
    <tbody>
      <tr th:each="cart : ${list}">
        <td>
          <!-- 체크박스 -->
           <input type="checkbox" th:checked="${cart.selected == 'Y'}"
                th:attr="data-cartno=${cart.cartno}"
                onchange="updateSelected(this)">
          <img th:src="@{|/products/storage/${cart.productsVO.thumb1}|}" width="80">
          <div th:text="${cart.productsVO.title}">상품명</div>
        </td>

        <!-- 수량 조절 UI -->
        <td>
          <div style="display:flex; align-items:center; gap:5px;">
            <button type="button"
                    th:attr="onclick=|changeCnt(${cart.cartno}, -1)|">-</button>
            <input type="text"
                  th:id="'cnt_' + ${cart.cartno}"
                  th:value="${cart.cnt}"
                  readonly style="width:40px; text-align:center;">
            <button type="button"
                    th:attr="onclick=|changeCnt(${cart.cartno}, 1)|">+</button>
          </div>
        </td>


        <td th:text="${#numbers.formatInteger(cart.productsVO.saleprice, 3, 'COMMA')} + '원'">0원</td>

        <td th:id="'subtotal_' + ${cart.cartno}"
            th:attr="data-unitprice=${cart.productsVO.saleprice}"
            th:text="${#numbers.formatInteger(cart.productsVO.saleprice * cart.cnt, 3, 'COMMA')} + '원'">
        </td>

        <td>
          <form th:action="@{/cart/delete}" method="post">
            <input type="hidden" name="cartno" th:value="${cart.cartno}" />
            <button type="submit">삭제</button>
          </form>
        </td>
      </tr>
    </tbody>
  </table>

  <div style="text-align:right; margin-top:20px;">
    <strong>총 합계:</strong>
    <span id="total_price"
          th:attr="data-total=${total}"
          th:text="${#numbers.formatInteger(total, 3, 'COMMA')} + '원'">0원</span>
  </div>


  <div style="text-align:right; margin-top:10px;">
    <form th:action="@{/cart/delete_all}" method="post" style="display:inline;">
      <button type="submit">전체 삭제</button>
    </form>
    <form th:action="@{/order/form}" method="get" style="display:inline;">
      <button type="submit">주문하기</button>
    </form>
  </div>

  <script>
  function changeCnt(cartno, delta) {
    const cntInput = document.getElementById("cnt_" + cartno);
    let cnt = parseInt(cntInput.value);
    cnt += delta;
    if (cnt < 1) return;

    fetch('/cart/update_cnt', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        cartno: cartno,
        cnt: cnt
      })
    })
    .then(response => {
      if (response.ok) {
        cntInput.value = cnt;

        // 단가 추출 → 합계 계산
        const subtotalEl = document.getElementById("subtotal_" + cartno);
        const unitPrice = parseInt(subtotalEl.dataset.unitprice);
        const subtotal = unitPrice * cnt;
        subtotalEl.innerText = subtotal.toLocaleString() + '원';

        // 총합 재계산
        updateTotalPrice();
      } else {
        alert("수량 변경 실패");
      }
    });
  }

  function updateTotalPrice() {
    let total = 0;
    document.querySelectorAll('[id^="subtotal_"]').forEach(el => {
      const unitPrice = parseInt(el.dataset.unitprice);
      const cntId = 'cnt_' + el.id.split('_')[1];
      const cnt = parseInt(document.getElementById(cntId).value);
      total += unitPrice * cnt;
    });

    document.getElementById("total_price").innerText = total.toLocaleString() + '원';
  }
  </script>

  <script>
  function updateSelected(checkbox) {
    const cartno = checkbox.getAttribute('data-cartno');
    const selected = checkbox.checked ? 'Y' : 'N';

    fetch('/cart/update_selected', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ cartno, selected })
    })
    .then(response => response.text())
    .then(result => {
      if (result !== 'success') {
        alert('선택 상태 변경 실패');
        checkbox.checked = !checkbox.checked; // 롤백
      }
    })
    .catch(error => {
      alert('오류 발생');
      checkbox.checked = !checkbox.checked; // 롤백
    });
  }
  </script>




</div>
</html>
