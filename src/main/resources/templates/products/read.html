<!DOCTYPE html> 

<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org"> <!-- layout.html ìƒì†-->

<div layout:fragment="content">
  <!--  Swiper CDN í¬í•¨ -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js"></script>
  <style>
    .products_read_container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .products_read_image_box {
      width: 48%;
      min-width: 320px;
    }
    .products_read_info_box {
      width: 48%;
      min-width: 320px;
    }
    .swiper {
      width: 100%;
      max-width: 600px;     /*  ìµœëŒ€ ê°€ë¡œ í¬ê¸° ì œí•œ */
      aspect-ratio: 1 / 1;   /*  ì •ì‚¬ê°í˜• ìœ ì§€ */
      background: #f9f9f9;
      margin: 0 auto;        /*  ê°€ìš´ë° ì •ë ¬ (ì˜µì…˜) */
    }

    .swiper-slide img {
      width: 100%;
      height: 100%;
      object-fit: cover;     /*  ì •ì‚¬ê°í˜• ì•ˆì— ê½‰ ì°¨ë„ë¡ */
      border-radius: 10px;   /* (ì„ íƒ) ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
    }

    .swiper-slide {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
    }
   
    .swiper-button-prev, .swiper-button-next {
      color: #333;
    }
    .products_read_content_separate {
      margin-top: 30px;
    }
  </style>

  <div class='title_line'>
    <span th:text="${cateVO.grp }" class="title_line_text"></span > 
    > <span th:text="${cateVO.name}" class="title_line_text"></span > 
    > ê¸€ ì¡°íšŒ
  </div>

  <aside class="aside_right">
    <a href="javascript:location.reload();">ìƒˆë¡œê³ ì¹¨</a>
    <span class='menu_divide'>â”‚</span>
    <a th:href="@{|./list_by_cateno_grid?cateno=${cateVO.cateno}&word=${word}&now_page=${now_page}|}">ëª©ë¡</a>
    <span class='menu_divide'>â”‚</span>
    <a th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}"
      th:href="@{|/products/update_text?productsno=${productsVO.productsno}&now_page=${now_page}&word=${word}|}">ê¸€ ìˆ˜ì •</a>
    <span class='menu_divide' th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}">â”‚</span>
    <a th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}"
      th:href="@{|./update_file?productsno=${productsVO.productsno}&word=${word}&now_page=${now_page}|}">íŒŒì¼ ìˆ˜ì •</a>
    <span class='menu_divide' th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}">â”‚</span>
    <a th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}"
      th:href="@{|/products/map?cateno=${productsVO.cateno}&productsno=${productsVO.productsno}|}">ì§€ë„</a>
    <span class='menu_divide' th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}">â”‚</span>
    <a th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}"
      th:href="@{|/products/youtube?cateno=${productsVO.cateno}&productsno=${productsVO.productsno}&word=${word}&now_page=${now_page}|}">Youtube</a>
    <span class='menu_divide' th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}">â”‚</span>
    <a th:if="${(session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)) and productsVO.cateno != null}"
      th:href="@{|./delete?productsno=${productsVO.productsno}&word=${word}&now_page=${now_page}&cateno=${productsVO.cateno}|}">ì‚­ì œ</a>
  </aside>

  <div class='menu_line'></div>

  <fieldset class="fieldset_basic">
    <ul>
      <li class="li_none">
        <div class="products_read_container">

          <!-- ì¢Œì¸¡ ì´ë¯¸ì§€ (Swiper ìŠ¬ë¼ì´ë“œ) -->
          <div class="products_read_image_box">
            <div class="swiper">
              <div class="swiper-wrapper">
                <div class="swiper-slide" th:if="${productsVO.file1saved != null && productsVO.file1saved.length() > 0}">
                  <img th:src="@{|/products/storage/${productsVO.file1saved}|}" alt="ì´ë¯¸ì§€1">
                </div>
                <div class="swiper-slide" th:if="${productsVO.file2saved != null && productsVO.file2saved.length() > 0}">
                  <img th:src="@{|/products/storage/${productsVO.file2saved}|}" alt="ì´ë¯¸ì§€2">
                </div>
                <div class="swiper-slide" th:if="${productsVO.file3saved != null && productsVO.file3saved.length() > 0}">
                  <img th:src="@{|/products/storage/${productsVO.file3saved}|}" alt="ì´ë¯¸ì§€3">
                </div>
              </div>
              <div class="swiper-button-prev"></div>
              <div class="swiper-button-next"></div>
              <div class="swiper-pagination"></div>
            </div>
          </div>

          <!-- ìš°ì¸¡ ìƒí’ˆ ì •ë³´ -->
          <div class="products_read_info_box">
            <div style="font-size: 1.5em; font-weight: bold;" th:text="${productsVO.title}"></div>
            <div style="font-size: 1em;" th:text="${productsVO.rdate}"></div><br>
            <div class="product-price-box">
              <span class="product-price-original" th:text="${#numbers.formatInteger(productsVO.price, 3, 'COMMA')} + 'ì›'"></span>
              <br>
              <span class="product-price-discount" th:text="${productsVO.dc} + '%'"></span>
              <span class="product-price-sale" th:text="${#numbers.formatInteger(productsVO.saleprice, 3, 'COMMA')} + 'ì›'"></span><br>

              <span class="product-expdate-label">ì†Œë¹„ê¸°í•œ</span>
              <span class="product-expdate" th:text="${#dates.format(productsVO.expdate, 'yyyy.MM.dd')}">YYYY.MM.DD</span>

            </div>
            <!-- ì ë¦½ í¬ì¸íŠ¸ ë°•ìŠ¤ -->
            <div class="point-box">
              <span th:text="'í¬ì¸íŠ¸ ì ë¦½: ' + ${productsVO.point} + 'ì '">í¬ì¸íŠ¸ ì ë¦½: 000ì </span>
            </div>
            <div class="products_read_recom" style="margin-top: 10px;">
              ì¶”ì²œ: <span id="hart_panel"></span> <span id="recom_panel">[[${productsVO.recom}]]ê°œ</span>
            </div>
            <!--  ì‹ ê·œ êµ¬ë§¤ ì˜ì—­ ì‹œì‘ -->
            <div class="products_read_purchase_wrap">

              <!-- ë¬´ë£Œë°°ì†¡ -->
              <div class="products_read_shipping">
                <strong>ë¬´ë£Œë°°ì†¡</strong>
                <div class="shipping_note">(ë‹¨, ì œì£¼ ë° ë„ì„œì‚°ê°„ì§€ì—­ì€ ë°°ì†¡ë¹„ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.)</div>
              </div>

              <hr class="products_read_divider">

              <!-- ìˆ˜ëŸ‰ ì„ íƒ -->
              <div class="products_read_quantity">
                <strong>êµ¬ë§¤ìˆ˜ëŸ‰</strong>
                <div class="quantity_box">
                  <button type="button" class="btn_qty" onclick="decreaseQty()">-</button>
                  <input type="text" id="qty" value="1" readonly>
                  <button type="button" class="btn_qty" onclick="increaseQty()">+</button>
                </div>
              </div>

              <hr class="products_read_divider">

              <!-- ì´ ìƒí’ˆ ê¸ˆì•¡ ë° ë²„íŠ¼ë“¤ -->
              <div class="products_read_total">
                <div>
                  <strong>ì´ ìƒí’ˆ ê¸ˆì•¡</strong><br>
                  <span id="total_price">[[${#numbers.formatInteger(productsVO.saleprice, 3, 'COMMA')}]]ì›</span>
                </div>

                <div class="purchase_button_box">
                  <button class="btn_cart"
                    th:onclick="|location.href='/cart/add?productsno=${productsVO.productsno}&cnt=' + document.getElementById('qty').value|">
                    ì¥ë°”êµ¬ë‹ˆ
                  </button>
                  <button class="btn_buy" onclick="location.href='/order/form?productsno=[[${productsVO.productsno}]]&qty=' + document.getElementById('qty').value">êµ¬ë§¤í•˜ê¸°</button>
                </div>
              </div>
            </div>
            <!--  ì‹ ê·œ êµ¬ë§¤ ì˜ì—­ ë -->
          </div>
        </div>
        <!--  ìˆ˜ëŸ‰ ì¦ê°€/ê°ì†Œ ìŠ¤í¬ë¦½íŠ¸ -->
        <script th:inline="javascript">
          //  ì „ì—­ ë³€ìˆ˜: ë‹¨ê°€ (Thymeleaf í‘œí˜„ì‹ â†’ JSë¡œ ì¹˜í™˜ë¨)
          const price = /*[[${productsVO.saleprice}]]*/ 0;

          function increaseQty() {
            let qty = parseInt(document.getElementById('qty').value);
            document.getElementById('qty').value = ++qty;
            updateTotal(qty);
          }

          function decreaseQty() {
            let qty = parseInt(document.getElementById('qty').value);
            if (qty > 1) {
              document.getElementById('qty').value = --qty;
              updateTotal(qty);
            }
          }

          function updateTotal(qty) {
            const total = price * qty;
            document.getElementById('total_price').innerText = total.toLocaleString() + 'ì›';
          }
        </script>
        <div class="products_read_content_separate">
          <hr>
          <h3>ìƒí’ˆ ì„¤ëª…</h3>
          <div th:utext="${productsVO.content}"></div>
        </div>
        <!--  ê´‘ê³  ì´ë¯¸ì§€ ì ‘ê¸°/í¼ì¹˜ê¸° ì˜ì—­ -->
        <div style="margin-top: 40px;">
          <div id="adImageBox" class="ad-image-box">
            <img th:if="${productsVO.fileAdsaved != null && productsVO.fileAdsaved.length() > 0}"
                th:src="@{|/products/storage/${productsVO.fileAdsaved}|}"
                alt="ê´‘ê³  ì´ë¯¸ì§€"
                style="max-width: 100%; border-radius: 10px;">
          </div>

          <div style="text-align: center; margin-top: 10px;">
            <button id="toggleAdBtn" class="ad-toggle-btn" onclick="toggleAdImage()">
              ìƒí’ˆì •ë³´ ë”ë³´ê¸° â–¼
            </button>
          </div>
          <br>
          <br>
        </div>

        <!--  ìƒí’ˆ ìƒì„¸ ì •ë³´ íƒ­ UI ì‹œì‘ -->
        <div class="product-tab-box">
          <ul class="product-tab-menu">
            <li class="product-tab-item active" onclick="showProductTab('detail')">ìƒí’ˆìƒì„¸</li>
            <li class="product-tab-item" onclick="showProductTab('review')"> ìƒí’ˆí‰(<span>0</span>) </li>
            <li class="product-tab-item" onclick="showProductTab('qna')">ìƒí’ˆë¬¸ì˜</li>
            <li class="product-tab-item" onclick="showProductTab('shipping')">ë°°ì†¡/êµí™˜/ë°˜í’ˆ ì•ˆë‚´</li>
          </ul>

          <div class="product-tab-content">
            <div id="product-tab-detail" class="product-tab-section"> 
              <!--  ìƒí’ˆìƒì„¸ í‘œ (3ì—´ êµ¬ì„±) -->
              <h3 class="product-info-title">í•„ìˆ˜ í‘œê¸°ì •ë³´</h3>

              <div class="product-info-grid">
                <div>í’ˆëª© ë˜ëŠ” ëª…ì¹­</div>
                <div th:text="${productsVO.item}">-</div>
                <div>í¬ì¥ë‹¨ìœ„ë³„ ë‚´ìš©ë¬¼ì˜ ìš©ëŸ‰(ì¤‘ëŸ‰), ìˆ˜ëŸ‰, í¬ê¸°</div>
                <div th:text="${productsVO.qty}">-</div>

                <div>ìƒì‚°ì(ìˆ˜ì…ì)</div>
                <div th:text="${productsVO.maker}">-</div>
                <div>ì›ì‚°ì§€</div>
                <div th:text="${productsVO.origin}">-</div>


                <div>ì œì¡°ì—°ì›”ì¼</div>
                <div th:text="${productsVO.makedate}">ì œí’ˆì— ë³„ë„ í‘œì‹œ</div>
                <div>ì„¸ë¶€ í’ˆëª©êµ°ë³„ í‘œì‹œì‚¬í•­</div>
                <div th:text="${productsVO.detail}">-</div>

                <div>ìˆ˜ì…ì‹í’ˆ ë¬¸êµ¬ ì—¬ë¶€</div>
                <div th:text="${productsVO.importyn}">-</div>
                <div>ìƒí’ˆ êµ¬ì„±</div>
                <div th:text="${productsVO.pack}">-</div>


                <div>ë³´ê´€ë°©ë²•,ì·¨ê¸‰ë°©ë²•</div>
                <div th:text="${productsVO.keep}">-</div>
                <div>ì†Œë¹„ìì•ˆì „ì„ ìœ„í•œ ì£¼ì˜ì‚¬í•­</div>
                <div th:text="${productsVO.safe}">-</div>

                <div>ì†Œë¹„ììƒë‹´ê´€ë ¨ ì „í™”ë²ˆí˜¸</div>
                <div th:text="${productsVO.counsel_tel}">-</div>
                <div style="grid-column: span 2;"></div> <!--  ë§ˆì§€ë§‰ ë‘ ì¹¸ ë³‘í•© -->
              </div>

              <div class="product-detail-warning">
                ğŸ”´ íŒë§¤ìê°€ í˜„ê¸ˆê±°ë˜ë¥¼ ìš”êµ¬í•˜ë©´ ê±°ë¶€í•˜ì‹œê³  ì¦‰ì‹œ ì‚¬ê¸° ê±°ë˜ ì‹ ê³ ì„¼í„° (1670-9832)ì— ì‹ ê³ í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.
              </div>

            </div>
            <div id="product-tab-review" class="product-tab-section" style="display: none;">
              <p>ìƒí’ˆí‰ ì˜ì—­ (ì¶”í›„ ì¶”ê°€ ì˜ˆì •)</p>
            </div>
            <div id="product-tab-qna" class="product-tab-section" style="display: none;">
              <p>ìƒí’ˆë¬¸ì˜ ì˜ì—­ (ì¶”í›„ ì¶”ê°€ ì˜ˆì •)</p>
            </div>
            <div id="product-tab-shipping" class="product-tab-section" style="display: none;">
              <p>ë°°ì†¡/êµí™˜/ë°˜í’ˆ ì•ˆë‚´ ì˜ì—­ (ì¶”í›„ ì¶”ê°€ ì˜ˆì •)</p>
            </div>
          </div>
        </div>
        <br>
        <!--  ìƒí’ˆ ìƒì„¸ ì •ë³´ íƒ­ UI ë -->
        <!--  íƒ­ ìŠ¤í¬ë¦½íŠ¸ -->
        <script>
          function showProductTab(tabName) {
            // ëª¨ë“  ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.product-tab-section').forEach(el => el.style.display = 'none');
            // ì„ íƒëœ ì½˜í…ì¸  í‘œì‹œ
            document.getElementById('product-tab-' + tabName).style.display = 'block';

            // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
            document.querySelectorAll('.product-tab-item').forEach(el => el.classList.remove('active'));
            // í˜„ì¬ íƒ­ í™œì„±í™”
            const tabMap = {
              detail: 0,
              review: 1,
              qna: 2,
              shipping: 3
            };
            document.querySelectorAll('.product-tab-item')[tabMap[tabName]].classList.add('active');
          }
        </script>
        <!-- ë³¸ë¬¸ ë‚´ìš© ë¶„ë¦¬ í‘œì‹œ -->
              <h5 style="padding: 10px 0;">ê´€ë ¨ ìƒí’ˆ</h5>
              <div id="related-container"></div>

              <script th:inline="javascript">
                const cateno = /*[[${cateVO.cateno}]]*/ 0;
              </script>

              <script>
                function formatDate(dateStr) {
                  if (!dateStr) return 'ì •ë³´ ì—†ìŒ';
                  const date = new Date(dateStr);
                  if (isNaN(date)) return 'ì •ë³´ ì—†ìŒ';

                  return [
                    date.getFullYear(),
                    String(date.getMonth() + 1).padStart(2, '0'),
                    String(date.getDate()).padStart(2, '0')
                  ].join('.');
                }
              </script>

              <script>
                let page = 1;
                let loading = false;

                function loadMoreRelated() {
                  if (loading) return;
                  loading = true;

                  fetch("/products/related_scroll", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams({
                      cateno: cateno,
                      productsno: productsno,
                      page: page
                    })
                  })
                  .then(response => response.json())
                  .then(data => {
                    const container = document.getElementById("related-container");

                    if (data.length === 0) {
                      window.removeEventListener("scroll", handleScroll);
                      return;
                    }

                    data.forEach(prod => {
                      const card = document.createElement("div");
                      card.classList.add("related-card");
                      card.innerHTML = `
                        <div style="position: relative;">
                          <a href="/products/read?productsno=${prod.productsno}">
                            <img src="/products/storage/${prod.thumb1}" alt="${prod.title}">
                          </a>
                          <button class="cart-btn" onclick="location.href='/cart/add?productsno=${prod.productsno}'"></button>
                        </div>

                        <div class="related-card-info">
                          <div class="related-card-title">${prod.title}</div>

                          <div style="display: flex; align-items: center; gap: 6px;">
                            <span style="color:red; font-weight:bold; white-space:nowrap;">
                              ${prod.dc || 0}%
                            </span>
                            <span style="color:black; font-weight:bold; white-space:nowrap;">
                              ${prod.saleprice.toLocaleString()}ì›
                            </span>
                          </div>

                          <div class="related-card-expdate">
                            ì†Œë¹„ê¸°í•œ: ${formatDate(prod.expdate)}
                          </div>


                          <div class="related-card-delivery">ë¬´ë£Œë°°ì†¡</div>

                          <div class="related-card-rating">â˜… 4.7 (33)</div>
                        </div>
                      `;
                      container.appendChild(card);
                    });

                    page++;
                    loading = false;
                  })
                  .catch(error => {
                    console.error("ê´€ë ¨ìƒí’ˆ ë¡œë”© ì‹¤íŒ¨:", error);
                  });
                }

                function handleScroll() {
                  const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
                  const windowHeight = window.innerHeight;
                  const scrollHeight = document.documentElement.scrollHeight;

                  if (scrollTop + windowHeight + 50 >= scrollHeight) {
                    loadMoreRelated();
                  }
                }

                window.addEventListener("scroll", handleScroll);
              </script>


              <!-- productsnoë¥¼ JS ë³€ìˆ˜ë¡œ ë¶„ë¦¬ -->
              <script th:inline="javascript">
                const productsno = /*[[${productsVO.productsno}]]*/ 0;
              </script>

              <script>
                //  í•˜íŠ¸ ì¶”ì²œ í† ê¸€ í•¨ìˆ˜
                function good(productsno) {
                  fetch("/products/good", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ productsno: productsno })
                  })
                  .then(response => response.json())
                  .then(data => {
                    if (data.isMember == 1) {
                      let tag = '';
                      if (data.hartCnt == 1) {
                        tag = `<a href="javascript:good(${productsno})">
                                <img src="/products/images/hart_on_50.png" style="width: 22px" title="ì¶”ì²œ">
                              </a>`;
                      } else {
                        tag = `<a href="javascript:good(${productsno})">
                                <img src="/products/images/hart_off_50.png" style="width: 22px" title="ì¶”ì²œ">
                              </a>`;
                      }
                      document.querySelector('#hart_panel').innerHTML = tag;
                      document.querySelector('#recom_panel').innerText = data.recom + 'ê°œ';
                    } else {
                      alert("ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                    }
                  })
                  .catch(error => {
                    console.error("ì¶”ì²œ ì²˜ë¦¬ ì‹¤íŒ¨:", error);
                  });
                }

                //  ì´ˆê¸°í™” (onload ë‚´ë¶€ì—ì„œ)
                window.onload = function() {
                  console.log("ğŸ”¥ ì„¸ì…˜ grade: [[${session.grade}]]");
                  console.log("ğŸ”¥ ì„¸ì…˜ memberno: [[${session.memberno}]]");

                  loadMoreRelated();

                  // Swiper ìŠ¬ë¼ì´ë“œ ì´ˆê¸°í™”
                  new Swiper('.swiper', {
                    loop: true,
                    navigation: {
                      nextEl: '.swiper-button-next',
                      prevEl: '.swiper-button-prev'
                    },
                    pagination: {
                      el: '.swiper-pagination',
                      clickable: true
                    }
                  });

                  // í•˜íŠ¸ ì´ˆê¸°í™”
                  let hartCnt = parseInt('[[${hartCnt}]]'); // ë¬¸ìì—´ â†’ ìˆ«ì ë³€í™˜
                  let tag = '';
                  if (hartCnt === 1) {
                    tag = `<a href="javascript:good(${productsno})">
                            <img src="/products/images/hart_on_50.png" style="width: 22px" title="ì¶”ì²œ">
                          </a>`;
                  } else {
                    tag = `<a href="javascript:good(${productsno})">
                            <img src="/products/images/hart_off_50.png" style="width: 22px" title="ì¶”ì²œ">
                          </a>`;
                  }
                  document.querySelector('#hart_panel').innerHTML = tag;

                  // ì¶”ì²œ ìˆ˜ í‘œì‹œë„ ê°™ì´ ì´ˆê¸°í™”
                  document.querySelector('#recom_panel').innerText = '[[${productsVO.recom}]]';
                };
              </script>
              <script>
                function toggleAdImage() {
                  const adBox = document.getElementById("adImageBox");
                  const btn = document.getElementById("toggleAdBtn");

                  const isOpen = adBox.classList.contains("show");

                  adBox.classList.toggle("show");
                  btn.innerText = isOpen ? "ìƒí’ˆì •ë³´ ë”ë³´ê¸° â–¼" : "ìƒí’ˆì •ë³´ ì ‘ê¸° â–²";
                }
              </script>

      </li>
    </ul>
  </fieldset>

</div>
</html>