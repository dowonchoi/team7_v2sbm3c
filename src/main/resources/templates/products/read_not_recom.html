<!DOCTYPE html> 

<html layout:decorate="~{layout}"> <!-- layout.html 상속-->
<!-- Swiper CSS & JS 추가 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<div layout:fragment="content">
  <div class='title_line'>
    <span th:text="${cateVO.grp }" class="title_line_text"></span > 
    > <span th:text="${cateVO.name}" class="title_line_text"></span > 
    > 글 조회
  </div>
  


  <aside class="aside_right">
    <a href="javascript:location.reload();">새로고침</a>
    <span class='menu_divide'>│</span>
    
    <a th:href="@{|./list_by_cateno_grid?cateno=${cateVO.cateno}&word=${word}&now_page=${now_page}|}">갤러리형</a>

    <!-- 관리자 등록 메뉴 -->
    <span class='menu_divide' th:if="${session.grade == 'admin'}">│</span>
    <a th:if="${session.grade == 'admin'}"
      th:href="@{|./create?cateno=${cateno}|}">등록</a>

    <!-- 수정/삭제/파일/지도/Youtube: admin 또는 본인글 supplier -->
    <span class='menu_divide' 
          th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}">│</span>
    <a th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}"
      th:href="@{|/products/update_text?productsno=${productsVO.productsno}&now_page=${now_page}&word=${word}|}">글 수정</a>

    <span class='menu_divide' 
          th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}">│</span>
    <a th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}"
      th:href="@{|./update_file?productsno=${productsVO.productsno}&word=${word}&now_page=${now_page}|}">파일 수정</a>

    <span class='menu_divide' 
          th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}">│</span>
    <a th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}"
      th:href="@{|/products/map?cateno=${productsVO.cateno}&productsno=${productsVO.productsno}|}">지도</a>

    <span class='menu_divide' 
          th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}">│</span>
    <a th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}"
      th:href="@{|/products/youtube?cateno=${productsVO.cateno}&productsno=${productsVO.productsno}&word=${word}&now_page=${now_page}|}">Youtube</a>

    <span class='menu_divide' 
          th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}">│</span>
    <a th:if="${session.grade == 'admin' or (session.grade == 'supplier' and session.memberno == productsVO.memberno)}"
      th:href="@{|./delete?productsno=${productsVO.productsno}&word=${word}&now_page=${now_page}&cateno=${productsVO.cateno}|}">삭제</a>
  </aside>
 
  <div class='menu_line'></div>

  <fieldset class="fieldset_basic">
    <ul>
      <li class="li_none">
        <div style="width: 100%; word-break: break-all;">
        
          <!-- 기존 정적 이미지 -->
          <!-- <div th:if="${productsVO.file1.endsWith('jpg') or productsVO.file1.endsWith('png') or productsVO.file1.endsWith('gif') or productsVO.file1.endsWith('jpeg')}">
            <img th:src="@{|/products/storage/${productsVO.file1saved}|}" 
                 style='width: 50%; float: left; margin-top: 0.5%; margin-right: 1%;'>
          </div> -->
          <!-- 이미지 슬라이드 시작 -->
          <div class="swiper" style="width: 60%; margin: 0 auto; padding-bottom: 20px;">
            <div class="swiper-wrapper">
              <div class="swiper-slide" 
                  th:if="${productsVO.file1saved != null && productsVO.file1saved.length() > 0}">
                <img th:src="@{|/products/storage/${productsVO.file1saved}|}" style="width: 100%;">
              </div>
              <div class="swiper-slide" 
                  th:if="${productsVO.file2saved != null && productsVO.file2saved.length() > 0}">
                <img th:src="@{|/products/storage/${productsVO.file2saved}|}" style="width: 100%;">
              </div>
              <div class="swiper-slide" 
                  th:if="${productsVO.file3saved != null && productsVO.file3saved.length() > 0}">
                <img th:src="@{|/products/storage/${productsVO.file3saved}|}" style="width: 100%;">
              </div>
            </div>

            <!-- 네비게이션 버튼 -->
            <div class="swiper-button-prev"></div>
            <div class="swiper-button-next"></div>

            <!-- 페이지 점 -->
            <div class="swiper-pagination"></div>
          </div>

          <script>
            const swiper = new Swiper('.swiper', {
              loop: true,
              navigation: {
                nextEl: '.swiper-button-next',
                prevEl: '.swiper-button-prev',
              },
              pagination: {
                el: '.swiper-pagination',
              },
            });
          </script>
          <span style="font-size: 1.5em; font-weight: bold;" th:text="${productsVO.title}"></span>
          <span style="font-size: 1em;" th:text="${productsVO.rdate }"></span><br><br>
          <!-- ✅ 개선된 가격 정보 표시 영역 -->
          <div class="price_info_box" style="font-size: 1.2em; margin-bottom: 15px;">
            <!-- 정가 -->
            <span style="text-decoration: line-through; font-size: 0.9em; color: gray;">
              <span th:text="${#numbers.formatInteger(productsVO.price_before, 3, 'COMMA')}">0</span>원
            </span>
            <br>
            <!-- 할인율 및 할인가 -->
            <span style="color: red; font-weight: bold; margin-left: 10px;" 
                  th:text="|${productsVO.discount}%|">0%</span><span style="font-weight: bold;" 
                  th:text="|${#numbers.formatInteger(productsVO.price_now, 3, 'COMMA')}원|">0원</span><br>

            <!-- 포인트 -->
            <span><b>포인트:</b> <span th:text="${productsVO.point}">0</span>p</span><br>

            <!-- 재고 -->
            <span><b>재고:</b> <span th:text="${productsVO.salecnt}">0</span> 개</span><br>

            <!-- 소비기한 -->
            <span><b>소비기한:</b>
              <span th:text="${#temporals.format(productsVO.expdate, 'yyyy.MM.dd')}">2025.06.30</span>
            </span>
          </div>
          <!-- 부가 적인 상품 관련 추가 끝-->
          <div style="white-space: pre-wrap;"><span th:text="${productsVO.content}"></span></div>
        </div>
      </li>

      <li class="li_none" style="clear: both; padding-top: 10px; padding-bottom: 25px;" 
           th:if="${productsVO.map.length() > 0}">
        <div style='text-align: center; width:640px; margin: 0px auto;'
             th:utext = "${productsVO.map }">
        </div>
      </li>

      <li class="li_none" style="clear: both; padding-top: 10px; padding-bottom: 25px;" 
          th:if="${productsVO.youtube.length() > 0}">
        <div style='text-align: center; width:640px; margin: 0px auto;'
           th:utext = "${productsVO.youtube }">
        </div>
      </li>

      <li class="li_none" th:text="|검색어(키워드): ${productsVO.word }|">
      </li>
      
      
    </ul>
  </fieldset>
  <!-- ✅ 하트 추천 영역 추가 -->
  <div style="margin-top: 20px;">
    추천: <span id="recom_panel">[[${productsVO.recom}]]개</span>
  </div>

  <!-- ✅ JS: productsno 및 초기 하트 상태 변수 -->
  <script th:inline="javascript">
    const productsno = /*[[${productsVO.productsno}]]*/ 0;
    const hartCnt = parseInt('[[${hartCnt}]]');  // 문자열 → 숫자
    const recom = parseInt('[[${productsVO.recom}]]'); // 추천 수
  </script>

  <script>
    // ✅ 하트 추천 토글 함수
    function good(productsno) {
      fetch("/products/good", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productsno: productsno })
      })
      .then(response => response.json())
      .then(data => {
        if (data.isMember == 1) {
          let tag = '';
          if (data.hartCnt == 1) {
            tag = `<a href="javascript:good(${productsno})">
                    <img src="/products/images/hart_on_50.png" style="width: 22px" title="추천">
                  </a>`;
          } else {
            tag = `<a href="javascript:good(${productsno})">
                    <img src="/products/images/hart_off_50.png" style="width: 22px" title="추천">
                  </a>`;
          }
          document.querySelector('#hart_panel').innerHTML = tag;
          document.querySelector('#recom_panel').innerText = data.recom + '개';
        } else {
          alert("로그인 후 이용 가능합니다.");
        }
      })
      .catch(error => {
        console.error("추천 처리 실패:", error);
      });
    }

    // ✅ 초기 하트 상태 렌더링
    window.onload = function () {
      let tag = '';
      if (hartCnt === 1) {
        tag = `<a href="javascript:good(${productsno})">
                <img src="/products/images/hart_on_50.png" style="width: 22px" title="추천">
              </a>`;
      } else {
        tag = `<a href="javascript:good(${productsno})">
                <img src="/products/images/hart_off_50.png" style="width: 22px" title="추천">
              </a>`;
      }
      document.querySelector('#hart_panel').innerHTML = tag;
      document.querySelector('#recom_panel').innerText = data.recom + '개';
    };
  </script>

</div>

</html>
