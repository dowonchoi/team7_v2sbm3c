<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>회원 이미지 생성</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .image-history img {
            width: 150px;
            height: auto;
            border-radius: 8px;
            margin: 5px;
            object-fit: cover;
            border: 1px solid #ddd;
        }
        .image-history {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
    </style>
</head>
<body class="container mt-4">
<h3 class="text-primary mb-3">AI 이미지 생성 (관리자/공급자 전용)</h3>

<!-- 프롬프트 입력 -->
<div class="mb-3">
    <textarea id="prompt" class="form-control" rows="4" placeholder="예: 비즈니스 프로필 이미지, 깔끔한 배경..."></textarea>
</div>

<!-- 버튼 -->
<div class="mb-3">
    <button id="generateBtn" class="btn btn-success">이미지 생성</button>
    <button id="retryBtn" class="btn btn-warning" style="display:none;">다시 생성</button>
</div>

<!-- 로딩 애니메이션 -->
<div id="loading" class="mt-3" style="display:none;">
    <div class="spinner-border text-success" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <span class="ms-2">이미지 생성 중...</span>
</div>

<!-- 결과 미리보기 -->
<div id="resultBox" class="mt-4" style="display:none;">
    <h5>생성된 이미지</h5>
    <img id="previewImg" src="" alt="이미지" class="img-fluid rounded shadow" style="max-width: 400px;">
</div>

<hr class="mt-5">

<!-- DB 저장된 이미지 목록 -->
<h5>내가 생성한 이미지</h5>
<div class="image-history mt-3">
    <div th:if="${#lists.isEmpty(imgList)}" class="text-muted">아직 생성된 이미지가 없습니다.</div>
    <div th:each="img : ${imgList}">
        <img th:src="@{|/member_img/storage/${img.filename}|}" alt="생성 이미지">
    </div>
</div>

<script>
document.getElementById("generateBtn").addEventListener("click", function () {
    generateImage();
});

document.getElementById("retryBtn").addEventListener("click", function () {
    generateImage();
});

function generateImage() {
    const prompt = document.getElementById("prompt").value.trim();
    if (!prompt) {
        alert("프롬프트를 입력하세요.");
        return;
    }

    document.getElementById("loading").style.display = "block";
    document.getElementById("resultBox").style.display = "none";

    fetch("/openai/member_img_ajax", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ prompt: prompt })
    })
    .then(response => response.json())
    .then(data => {
        console.log("DEBUG Response:", data); // ✅ FastAPI → Spring → 브라우저까지 값 확인
        if (data.success) {
            const imgPath = "/member_img/storage/" + data.filename;
            document.getElementById("previewImg").src = imgPath;
            document.getElementById("resultBox").style.display = "block";
            document.getElementById("retryBtn").style.display = "inline-block";
        } else {
            alert(data.error);
        }
    })
    .catch(err => alert("오류 발생: " + err.message))
    .finally(() => {
        document.getElementById("loading").style.display = "none";
    });
}
</script>
</body>
</html>
