<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org" lang="ko">
<div layout:fragment="content">

<div class="main-container">
    <!-- 왼쪽 -->
    <div class="left-section">
        <div>
            <h2>무료 온라인 AI 이미지 생성기</h2>
            <p class="subtitle">상품 페이지에 넣을 이미지를 생성하세요. AI가 단어를 멋진 이미지로 바꿔줍니다.</p>

            <div class="textarea-wrapper">
                <textarea id="prompt" placeholder="예: 하얀 배경 속 그릇에 담긴 레몬 조각과 레몬..."></textarea>
                <button type="button" class="clear-btn" onclick="clearPrompt()">×</button>
            </div>
        </div>

        <div>
            <button id="generateBtn" class="btn-generate">AI 이미지 생성</button>
            <div id="loading" style="display:none;">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>이미지 생성 중...</p>
            </div>
        </div>
    </div>

    <!-- 오른쪽 -->
    <div class="right-section">
        <div id="placeholderBox">
            <img src="/images/placeholder.jpg" alt="예시 이미지" class="placeholder-img">
        </div>

        <div id="resultBox" style="display:none;">
            <img id="previewImg" src="" alt="생성된 이미지">
        </div>
    </div>
</div>

<!-- 내가 생성한 이미지 -->
<div class="image-history-container">
    <h5>내가 생성한 이미지</h5>
    <div class="image-history">
        <div th:if="${#lists.isEmpty(imgList)}" class="text-muted">아직 생성된 이미지가 없습니다.</div>
        <div th:each="img : ${imgList}">
            <img th:src="@{|/member_img/storage/${img.filename}|}" alt="생성 이미지" onclick="openModal(this.src)">
        </div>
    </div>
</div>

<!-- ✅ 모달 -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-transparent border-0 text-center">
            <img id="modalImg" src="" alt="확대 이미지" class="modal-img">
        </div>
    </div>
</div>

<!-- ✅ 스타일 -->
<style>
    body { background: #f4f6f8; font-family: 'Noto Sans KR', sans-serif; }
    .main-container { max-width: 1200px; margin: 40px auto; background: #fff; border-radius: 16px; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08); padding: 40px; display: flex; gap: 30px; align-items: stretch; min-height: 500px; }
    .left-section { flex: 1; display: flex; flex-direction: column; justify-content: space-between; }
    .right-section { flex: 1; display: flex; justify-content: center; align-items: center; }
    h2 { font-weight: bold; color: #222; margin-bottom: 14px; }
    .subtitle { font-size: 15px; color: #555; margin-bottom: 18px; }
    .textarea-wrapper { position: relative; width: 100%; margin-bottom: 20px; }
    textarea { width: 100%; border-radius: 10px; border: 1px solid #ddd; padding: 14px 40px 14px 14px; font-size: 16px; resize: none; height: 280px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.03); }
    .clear-btn { position: absolute; top: 8px; right: 10px; background: transparent; border: none; font-size: 18px; color: #888; cursor: pointer; }
    .clear-btn:hover { color: #4CAF50; }
    .btn-generate { background-color: #4CAF50; color: #fff; font-weight: bold; padding: 14px 20px; font-size: 16px; border-radius: 8px; border: none; width: 100%; }
    #loading { color: #4CAF50; margin-top: 12px; }
    #previewImg, .placeholder-img { border-radius: 14px; box-shadow: 0 4px 14px rgba(0,0,0,0.15); width: 100%; height: auto; max-height: 450px; object-fit: cover; }
    .placeholder-img { opacity: 0.9; }
    .image-history-container { margin: 40px auto; max-width: 1200px; background: #fff; border-radius: 16px; padding: 25px; box-shadow: 0 6px 18px rgba(0,0,0,0.06); }
    .image-history { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 20px; }
    .image-history img { width: 100%; border-radius: 10px; border: 1px solid #eee; object-fit: cover; transition: 0.3s; cursor: pointer; }
    .image-history img:hover { transform: scale(1.05); }
    .modal-img { max-width: 90%; max-height: 80vh; border-radius: 12px; }
</style>

<!-- ✅ JS -->
<script>
document.getElementById("generateBtn").addEventListener("click", generateImage);

function clearPrompt() {
    document.getElementById("prompt").value = "";
}

function generateImage() {
    const prompt = document.getElementById("prompt").value.trim();
    if (!prompt) {
        alert("프롬프트를 입력하세요.");
        return;
    }
    document.getElementById("loading").style.display = "block";
    document.getElementById("resultBox").style.display = "none";
    document.getElementById("placeholderBox").style.display = "none";
    fetch("/openai/member_img_ajax", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ prompt: prompt })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const imgPath = "/member_img/storage/" + data.filename;
            document.getElementById("previewImg").src = imgPath;
            document.getElementById("resultBox").style.display = "block";
        } else {
            alert(data.error);
        }
    })
    .catch(err => alert("오류 발생: " + err.message))
    .finally(() => {
        document.getElementById("loading").style.display = "none";
    });
}

function openModal(src) {
    document.getElementById("modalImg").src = src;
    const modal = new bootstrap.Modal(document.getElementById('imageModal'));
    modal.show();
}
</script>

</div>
</html>
