<!-- 관리자 공급자 승인/거절/취소/다운로드 기능 화면 -->
<!DOCTYPE html>
<html layout:decorate="~{layout}">
<div layout:fragment="content">

  <div class='title_line'>공급자 승인 관리 (관리자 전용)</div>

  <aside class="aside_right">
  <a href="javascript:location.reload();">새로고침</a>
  <span class='menu_divide'>│</span>
  <a href="/member/list">회원 목록</a>  <!-- 추가된 회원 목록 링크 -->
</aside>


  <table class="table table-hover table-striped" style='width: 100%;'>
    <colgroup>
      <col style='width: 10%;'/>
      <col style='width: 15%;'/>
      <col style='width: 15%;'/>
      <col style='width: 20%;'/>
      <col style='width: 15%;'/>
      <col style='width: 10%;'/>
      <col style='width: 15%;'/>
    </colgroup>

    <thead>
      <tr>
        <th>ID</th>
        <th>성명</th>
        <th>전화번호</th>
        <th>주소</th>
        <th>인증 파일</th>
        <th>상태</th>
        <th>관리</th>
      </tr>
    </thead>

    <tbody>
      <tr th:each="memberVO : ${supplierList}">
        <td th:text="${memberVO.id}"></td>
        <td th:text="${memberVO.mname}"></td>
        <td th:text="${memberVO.tel}"></td>
        <td th:text="${memberVO.address1} + ' ' + ${memberVO.address2}"></td>

        <!-- 인증 파일 -->
        <td>
          <div th:if="${memberVO.business_file_name != null}">
            <button type="button" class="btn btn-info btn-sm"
                    th:onclick="|showPreview('/member/storage/${memberVO.business_file_name}')|">파일</button>
            |
            <a th:href="@{/member/storage/{file}(file=${memberVO.business_file_name})}" download>↓</a>
          </div>
          <span th:if="${memberVO.business_file_name == null}">-</span>
        </td>

        <!-- 승인 상태 -->
        <td>
          <span th:if="${memberVO.supplier_approved == 'Y'}" style="color:green;">승인됨</span>
          <span th:if="${memberVO.supplier_approved == 'N'}" style="color:red;">대기중</span>
          <span th:if="${memberVO.supplier_approved == 'R'}" style="color:gray;">거절됨</span>
        </td>
        
        <!-- 관리 버튼 (항상 보이도록 수정) -->
        <td>
          <!-- 승인 버튼 -->
          <button class="btn btn-sm btn-success"
                  th:onclick="|approve(${memberVO.memberno})|">승인</button>

          <!-- 승인 취소 버튼 (항상 활성화) -->
          <button class="btn btn-sm btn-warning"
                  th:onclick="|cancel(${memberVO.memberno})|">승인 취소</button>
        </td>

      </tr>
    </tbody>
  </table>

  <!-- ✅ 파일 미리보기용 모달 -->
  <div id="filePreviewModal" style="display:none; position:fixed; top:10%; left:20%; width:60%; height:80%; background:white; border:2px solid #ccc; z-index:9999; box-shadow:0 0 20px rgba(0,0,0,0.5); padding:15px;">
    <div style="text-align:right;">
      <button class="btn btn-sm btn-danger" onclick="closePreview()">닫기</button>
    </div>
    <div id="previewContainer" style="width:100%; height:90%; text-align:center;">
      <!-- 미리보기 내용 -->
    </div>
  </div>

  <script>
    function approve(memberno) {
      if (confirm("해당 공급자를 승인하시겠습니까?")) {
        fetch('/member/admin/approveSupplier', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'memberno=' + memberno
        }).then(r => r.text()).then(msg => location.reload());
      }
    }

    function cancel(memberno) {
      if (confirm("해당 공급자의 승인을 취소하시겠습니까?")) {
        fetch('/member/admin/cancelApproval', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: 'memberno=' + memberno
        }).then(msg => {
            if (msg.trim() === 'success') {
              alert("처리되었습니다.");
              location.reload();
            } else {
              alert("처리에 실패했습니다: " + msg);
            }
          })
      }
    }

    function showPreview(fileUrl) {
      const ext = fileUrl.split('.').pop().toLowerCase();
      const container = document.getElementById("previewContainer");

      if (["jpg", "jpeg", "png", "gif"].includes(ext)) {
        container.innerHTML = `<img src="${fileUrl}" style="max-width:100%; max-height:100%;">`;
      } else if (["pdf"].includes(ext)) {
        container.innerHTML = `<iframe src="${fileUrl}" style="width:100%; height:100%;" frameborder="0"></iframe>`;
      } else {
        container.innerHTML = `미리보기를 지원하지 않는 형식입니다. <a href="${fileUrl}" download>다운로드</a>`;
      }

      document.getElementById("filePreviewModal").style.display = "block";
    }

    function closePreview() {
      document.getElementById("filePreviewModal").style.display = "none";
      document.getElementById("previewContainer").innerHTML = "";
    }
  </script>
</div>
</html>
