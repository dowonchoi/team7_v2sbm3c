<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org">
<div layout:fragment="content">

<link rel="stylesheet" href="/css/list.css">

<head>
  <title>COMMUNITY</title>
</head>
<body>
  <div class="community-title">COMMUNITY</div>

  <div class="community-tabs">
    <a href="#" data-target="noticeSection">NOTICE</a>
    <a href="#" data-target="faqSection">FAQ</a>
    <a href="#" data-target="qnaUserSection">Q&A (ì†Œë¹„ì)</a>
    <a href="#" data-target="qnaSupplierSection">Q&A (ê³µê¸‰ì)</a>
  </div>

  <div class="community-controls">
    <div class="left-group">
      <!-- âœ… ì¹´í…Œê³ ë¦¬ ì„ íƒë§Œ ë”°ë¡œ ê°ì‹¸ì„œ ì œì–´ -->
      <div id="categoryFilterWrapper">
        <select id="categoryFilter" class="category-select">
          <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
          <option value="ê³µì§€">ê³µì§€</option>
          <option value="ì´ë²¤íŠ¸">ì´ë²¤íŠ¸</option>
          <option value="ë°°ì†¡ì•ˆë‚´">ë°°ì†¡ì•ˆë‚´</option>
          <option value="ìƒí’ˆì •ë³´">ìƒí’ˆì •ë³´</option>
        </select>
      </div>

      <!-- âœ… ê²€ìƒ‰ì°½ì€ í•­ìƒ í‘œì‹œ -->
      <form class="search-box" onsubmit="searchKeyword(event)">
        <input type="text" id="searchInput" placeholder="Search">
        <button type="submit">ğŸ”</button>
      </form>
    </div>

    <!-- âœ… ê¸€ì“°ê¸° ë²„íŠ¼ì€ í•­ìƒ í‘œì‹œë˜ë˜ ë‚´ìš©ë§Œ ë°”ë€œ -->
    <div id="writeButtonArea">
      <a href="/notice/create" class="btn-write">ê¸€ì“°ê¸°</a>
    </div>
  </div>

  <div class="community-section">
    <table>
      <thead id="tableHeader">
        <tr>
          <th>No</th>
          <th>ì œëª©</th>
          <th>ì‘ì„±ì‹œê°„</th>
          <th>ì¡°íšŒìˆ˜</th>
        </tr>
      </thead>
      <tbody id="listArea">
        <!-- NOTICE -->
        <tr th:each="notice, stat : ${noticeList}" class="noticeSection">
          <td th:text="${stat.count}"></td>
          <td><a th:href="@{'/notice/read?notice_id=' + ${notice.notice_id}}" th:text="${notice.title}"></a></td>
          <td th:text="${#dates.format(notice.reg_date, 'yyyy-MM-dd HH:mm')}"></td>
          <td th:text="${notice.view_count}"></td>
        </tr>

        <!-- FAQ -->
        <tr class="faqSection" style="display:none;">
          <td colspan="4">
            <div class="faq-category-buttons">
              <button onclick="filterFAQ('ì „ì²´')">ì „ì²´</button>
              <button onclick="filterFAQ('ê¸°íƒ€')">ê¸°íƒ€</button>
              <button onclick="filterFAQ('êµí™˜/ë°˜í’ˆ')">êµí™˜/ë°˜í’ˆ</button>
              <button onclick="filterFAQ('íšŒì›ì„œë¹„ìŠ¤')">íšŒì›ì„œë¹„ìŠ¤</button>
              <button onclick="filterFAQ('ê°œì¸ì •ë³´')">ê°œì¸ì •ë³´</button>
              <button onclick="filterFAQ('ì£¼ë¬¸/ê²°ì œ')">ì£¼ë¬¸/ê²°ì œ</button>
              <button onclick="filterFAQ('í™˜ë¶ˆ')">í™˜ë¶ˆ</button>
            </div>
            <div class="faq-list">
              <div th:each="faq : ${faqList}" class="faq-item" th:data-cate="${faq.cate}">
                <div class="faq-question" onclick="toggleAnswer(this)">
                  <span>Q</span>
                  <span th:text="${faq.question}"></span>
                </div>
                <div class="faq-answer">
                  <span>A</span>
                  <span th:text="${faq.answer}"></span>
                  <div th:if="${session.grade >= 1 and session.grade <= 4}">
                    <a th:href="@{'/faq/update?faq_id=' + ${faq.faq_id}}" style="margin-left:10px; color:#6db75b;">ìˆ˜ì •</a>
                    <a th:href="@{'/faq/delete?faq_id=' + ${faq.faq_id}}" style="margin-left:10px; color:red;" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</a>
                  </div>
                </div>
              </div>
            </div>
          </td>
        </tr>

        <!-- ì†Œë¹„ì Q&A -->
        <tr th:each="qna, stat : ${qnaUserList}" class="qnaUserSection" style="display:none;">
          <td th:text="${stat.count}"></td>
          <td><a th:href="@{'/qna/read?qna_id=' + ${qna.qna_id}}" th:text="${qna.title}"></a></td>
          <td th:text="${#dates.format(qna.reg_date, 'yyyy-MM-dd HH:mm')}"></td>
          <td th:text="${qna.view_count}"></td>
        </tr>

        <!-- ê³µê¸‰ì Q&A -->
        <tr th:each="qna, stat : ${qnaSupplierList}" class="qnaSupplierSection" style="display:none;">
          <td th:text="${stat.count}"></td>
          <td><a th:href="@{'/qna/read?qna_id=' + ${qna.qna_id}}" th:text="${qna.title}"></a></td>
          <td th:text="${#dates.format(qna.reg_date, 'yyyy-MM-dd HH:mm')}"></td>
          <td th:text="${qna.view_count}"></td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    const tabs = document.querySelectorAll('.community-tabs a');
    const writeButtonArea = document.getElementById('writeButtonArea');
    const categoryFilterWrapper = document.getElementById('categoryFilterWrapper');
    let currentTab = 'noticeSection';

    tabs.forEach(tab => {
      tab.addEventListener('click', e => {
        e.preventDefault();
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        currentTab = tab.getAttribute('data-target');

        document.querySelectorAll('#listArea tr').forEach(tr => tr.style.display = 'none');
        document.querySelectorAll(`#listArea .${currentTab}`).forEach(tr => tr.style.display = '');

        // âœ… ì¹´í…Œê³ ë¦¬ selectë§Œ í‘œì‹œ/ìˆ¨ê¹€
        categoryFilterWrapper.style.display = (currentTab === 'noticeSection') ? 'inline-block' : 'none';

        // âœ… ê¸€ì“°ê¸° ë²„íŠ¼ ë§í¬ë§Œ ë³€ê²½
        let writeLink = '/notice/create';
        if (currentTab === 'faqSection') {
          writeLink = '/faq/create';
        } else if (currentTab === 'qnaUserSection') {
          writeLink = '/qna/create_user';
        } else if (currentTab === 'qnaSupplierSection') {
          writeLink = '/qna/create_supplier';
        }
        writeButtonArea.innerHTML = `<a href="${writeLink}" class="btn-write">ê¸€ì“°ê¸°</a>`;

        document.getElementById('searchInput').value = '';
        updateHeaderVisibility();
      });
    });

    function searchKeyword(event) {
      event.preventDefault();
      const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
      const rows = document.querySelectorAll(`#listArea .${currentTab}`);
      rows.forEach(row => {
        const title = row.querySelector('td:nth-child(2) a');
        if (title && title.innerText.toLowerCase().includes(keyword)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    }

    tabs[0].click(); // ì´ˆê¸° NOTICE íƒ­ ì„ íƒ
    updateHeaderVisibility();

    function toggleAnswer(element) {
      const answer = element.nextElementSibling;
      const isActive = element.classList.contains('active');

      document.querySelectorAll('.faq-answer').forEach(a => a.style.display = 'none');
      document.querySelectorAll('.faq-question').forEach(q => q.classList.remove('active'));

      if (!isActive) {
        answer.style.display = 'block';
        element.classList.add('active');
      }
    }

    function filterFAQ(category) {
      const items = document.querySelectorAll('.faq-item');
      items.forEach(item => {
        const itemCate = item.getAttribute('data-cate');
        if (category === 'ì „ì²´' || itemCate === category) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    }

    function updateHeaderVisibility() {
      const tableHeader = document.getElementById('tableHeader');
      tableHeader.style.display = (currentTab === 'faqSection') ? 'none' : '';
    }
  </script>
</body>
</div>
</html>
