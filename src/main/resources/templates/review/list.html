<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <link rel="stylesheet" href="@{/css/review_list.css}">
  
  <div th:fragment="reviewListFragment(reviewList, productsno)">
    <div class="review-list-box">

      <!-- ë¦¬ë·°ê°€ ì—†ì„ ë•Œ -->
      <div class="review-empty" th:if="${#lists.isEmpty(reviewList)}">
        <p>ì‘ì„±ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
      </div>

      <!-- ë¦¬ë·° ëª©ë¡ ì»¨í…Œì´ë„ˆ -->
      <div id="review-container" class="review-container">
        <div th:each="review, stat : ${reviewList}" th:if="${stat.index < 3}" class="review-item">
          
          <!-- ì‘ì„±ì + ë‚ ì§œ + ìˆ˜ì •ë²„íŠ¼ -->
          <div class="review-header">
            <!-- ì™¼ìª½: ì´ë¦„ + ë‚ ì§œ -->
            <div class="review-user-info">
              <strong class="review-author" th:text="${review.mname}">ì‘ì„±ì</strong>
              <span class="review-date" th:text="${#dates.format(review.rdate, 'yyyy.MM.dd')}"></span>
            </div>
            <!-- ì˜¤ë¥¸ìª½: ë²„íŠ¼ -->
            <div class="review-btn-group" th:if="${sessionMemberno == review.memberno}">
              <a th:href="@{'/review/update?reviewno=' + ${review.reviewno}}" class="btn btn-sm review-btn">ìˆ˜ì •</a>
              <a th:href="@{'/review/update_file?reviewno=' + ${review.reviewno}}" class="btn btn-sm review-btn">ì´ë¯¸ì§€ ìˆ˜ì •</a>
              <form th:action="@{/review/delete_proc}" method="post" style="display:inline;">
                <input type="hidden" name="reviewno" th:value="${review.reviewno}" />
                <button type="submit" class="btn btn-sm review-btn-danger" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
              </form>
            </div>
          </div>


          <!-- ê°ì • ë¶„ì„ + ìš”ì•½ -->
          <div class="review-emotion-summary">
            <span class="review-emotion">
              <strong>ê°ì • ë¶„ì„:</strong>
              <span th:if="${review.emotion == 1}">ğŸ˜Š ê¸ì •ì ì¸ ìƒí’ˆí›„ê¸°ì…ë‹ˆë‹¤.</span>
              <span th:if="${review.emotion == 0}">â˜¹ï¸ ë¶€ì •ì ì¸ ìƒí’ˆí›„ê¸°ì…ë‹ˆë‹¤.</span>
              <span th:if="${review.emotion == null}">â” ë¶„ì„ë˜ì§€ ì•ŠìŒ</span>
            </span>
            <br>
            <span class="review-summary" th:if="${review.summary != null}">
              <strong>ìš”ì•½:</strong> <span th:text="${review.summary}"></span>
            </span>
          </div>

          <!-- âœ… ë³¸ë¬¸ (ê°„ê²© í™•ë³´) -->
          <p class="review-text" style="margin-top: 12px;" th:text="${review.content}"></p>


          <!-- ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸ -->
          <div class="review-images">
            <div th:if="${review.file1saved != null and review.file1saved != ''}">
              <img class="review-image" th:src="@{'/review/storage/' + ${review.file1saved}}" alt="ë¦¬ë·° ì´ë¯¸ì§€1">
            </div>
            <div th:if="${review.file2saved != null and review.file2saved != ''}">
              <img class="review-image" th:src="@{'/review/storage/' + ${review.file2saved}}" alt="ë¦¬ë·° ì´ë¯¸ì§€2">
            </div>
            <div th:if="${review.file3saved != null and review.file3saved != ''}">
              <img class="review-image" th:src="@{'/review/storage/' + ${review.file3saved}}" alt="ë¦¬ë·° ì´ë¯¸ì§€3">
            </div>
          </div>

          <hr class="review-divider">
        </div>
        <!-- âœ… í´ë¦­ ì‹œ ë³´ì—¬ì¤„ ì´ë¯¸ì§€ ëª¨ë‹¬ -->
        <div id="imageModal" class="image-modal">
          <span class="image-modal-close" onclick="closeModal()">&times;</span>
          <img id="modalImage" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€">
        </div>
      </div>

      <!-- ë”ë³´ê¸° ë²„íŠ¼ -->
      <div class="review-more-btn-box">
        <button id="loadMoreBtn" class="btn btn-outline-primary" style="display:none;">ë”ë³´ê¸°</button>
        <button id="collapseBtn" class="btn btn-outline-secondary" style="display:none;">ì ‘ê¸°</button>
      </div>

      <!-- Ajax ìŠ¤í¬ë¦½íŠ¸ ë™ì¼ -->
      <script th:inline="javascript">
        let offset = 3;
        let limit = 3;

        if (typeof productsno === 'undefined') {
          var productsno = /*[[${productsno}]]*/ 0;
        }

        const sessionMemberno = /*[[${sessionMemberno != null ? sessionMemberno : 0}]]*/ 0;
        const initialCount = /*[[${reviewList != null ? reviewList.size() : 0}]]*/ 0;

        document.addEventListener("DOMContentLoaded", function() {
          const btn = document.getElementById("loadMoreBtn");
          const collapseBtn = document.getElementById("collapseBtn");
          const container = document.getElementById("review-container");

          if (initialCount >= 3) btn.style.display = "block";

          btn.addEventListener("click", function() {
            fetch(`/review/more?productsno=${productsno}&offset=${offset}&limit=${limit}`)
              .then(response => response.json())
              .then(data => {
                if (data.length === 0) {
                  btn.style.display = "none";
                  return;
                }

                data.forEach(review => {
                  const isOwner = sessionMemberno === review.memberno;
                  let emotionText = '';
                  if (review.emotion === 1) {
                    emotionText = 'ğŸ˜Š ê¸ì •ì ì¸ ìƒí’ˆí›„ê¸°ì…ë‹ˆë‹¤.';
                  } else if (review.emotion === 0) {
                    emotionText = 'â˜¹ï¸ ë¶€ì •ì ì¸ ìƒí’ˆí›„ê¸°ì…ë‹ˆë‹¤.';
                  } else {
                    emotionText = 'â” ë¶„ì„ë˜ì§€ ì•ŠìŒ';
                  }

                  let summaryText = review.summary ? `ìš”ì•½: ${review.summary}` : '';
                  const buttonsHtml = isOwner ? `
                    <div class="review-btn-group">
                      <a href="/review/update?reviewno=${review.reviewno}" class="btn btn-sm review-btn">ìˆ˜ì •</a>
                      <a href="/review/update_file?reviewno=${review.reviewno}" class="btn btn-sm review-btn">ì´ë¯¸ì§€ ìˆ˜ì •</a>
                      <form action="/review/delete_proc" method="post" style="display:inline;">
                        <input type="hidden" name="reviewno" value="${review.reviewno}">
                        <button type="submit" class="btn btn-sm review-btn-danger" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
                      </form>
                    </div>
                  ` : '';


                  const reviewHtml = `
                    <div class="review-item appended">
                      <div class="review-header">
                        <div class="review-user-info">
                          <strong class="review-author">${review.mname}</strong>
                          <span class="review-date">${formatDate(review.rdate)}</span>
                        </div>
                        ${buttonsHtml}
                      </div>
                      <div class="review-emotion-summary">
                        ê°ì • ë¶„ì„: ${emotionText}<br>${summaryText}
                      </div>
                      <p class="review-text" style="margin-top: 12px;">${review.content}</p>
                      <div class="review-images">
                        ${review.file1saved ? `<div><img class="review-image" src="/review/storage/${review.file1saved}"></div>` : ''}
                        ${review.file2saved ? `<div><img class="review-image" src="/review/storage/${review.file2saved}"></div>` : ''}
                        ${review.file3saved ? `<div><img class="review-image" src="/review/storage/${review.file3saved}"></div>` : ''}
                      </div>
                      <hr class="review-divider">
                    </div>
                  `;
                  container.insertAdjacentHTML('beforeend', reviewHtml);
                });

                offset += limit;
                if (data.length < limit) btn.style.display = "none";
                collapseBtn.style.display = "block";
              })
              .catch(error => console.error("ë¦¬ë·° ë¡œë”© ì‹¤íŒ¨:", error));
          });

          collapseBtn.addEventListener("click", function() {
            document.querySelectorAll('.review-item.appended').forEach(el => el.remove());
            offset = 3;
            collapseBtn.style.display = "none";
            if (initialCount > 3) {
              btn.style.display = "block";
            }
          });
        });

        function formatDate(dateStr) {
          const date = new Date(dateStr);
          return `${date.getFullYear()}.${(date.getMonth()+1).toString().padStart(2,'0')}.${date.getDate().toString().padStart(2,'0')}`;
        }

        // âœ… ì´ë¯¸ì§€ í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
        document.addEventListener('click', function(e) {
          if (e.target.classList.contains('review-image')) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'flex';
            modalImg.src = e.target.src; // í´ë¦­í•œ ì´ë¯¸ì§€ ê²½ë¡œ
          }
        });

        // âœ… ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
          document.getElementById('imageModal').style.display = 'none';
        }

        // âœ… ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('imageModal').addEventListener('click', function(e) {
          if (e.target === this) {
            closeModal();
          }
        });
      </script>
    </div>
  </div>
</html>
