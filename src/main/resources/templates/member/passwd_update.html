<!DOCTYPE html>
<html layout:decorate="~{layout}">

<div layout:fragment="content">
<script th:inline="javascript">
  window.onload = () => {
    const userGrade = /*[[${session.grade}]]*/ 'guest'; // 없는 경우 guest로 처리

    if (userGrade !== 'admin') {
      alert('⚠️ 비밀번호 변경은 관리자만 가능합니다.\n비밀번호 찾기 화면으로 이동합니다.');
      location.href = '/member/find_passwd';
      return;
    }

    document.getElementById('btn_send').addEventListener('click', send);

    document.querySelector('#current_passwd').addEventListener('keypress', (event) => {
      if(event.key === 'Enter') document.getElementById('passwd').focus();
    });

    document.querySelector('#passwd').addEventListener('keypress', (event) => {
      if(event.key === 'Enter') document.getElementById('passwd2').focus();
    });

    document.querySelector('#passwd2').addEventListener('keypress', (event) => {
      if(event.key === 'Enter') document.getElementById('btn_send').focus();
    });
  }

  function send() {
    let url = './passwd_check';
    let passwd = document.getElementById("current_passwd").value;

    fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ current_passwd: passwd })
    })
    .then(response => response.json())
    .then(rdata => {
      if (rdata.cnt == 0) {
        current_passwd_msg.innerHTML = '현재 패스워드가 일치하지 않습니다.';
        current_passwd_msg.classList.add('span_warning');
        current_passwd.focus();
        return false;
      } else {
        current_passwd_msg.innerHTML = "";

        let passwd = document.getElementById('passwd');
        let passwd2 = document.getElementById('passwd2');
        let passwd2_msg = document.getElementById('passwd2_msg');

        if (passwd.value !== passwd2.value) {
          passwd2_msg.innerHTML = '입력된 패스워드가 일치하지 않습니다.';
          passwd2_msg.classList.add('span_warning');
          passwd.focus();
          return false;
        }

        document.getElementById('frm').submit();
      }
    })
    .catch(error => {
      console.error('Error:', error);
    });

    current_passwd_msg.innerHTML = "<img src='/images/progress.gif' style='width: 5%;'>";
  }
</script>

<div class="title_line">
  패스워드 변경 > <span th:text="@{|${memberVO.mname} (${memberVO.id})|}"></span>
</div>

<aside class="aside_right">
  <a href="javascript:location.reload();">새로고침</a>
  <span class='menu_divide'>│</span> 
  <a href='./create'>회원 가입</a>
  <span class='menu_divide'>│</span> 
  <a href='./list'>목록</a>
</aside> 

<div class='menu_line'></div>

<div style="width: 30%; margin: 0 auto">
  <form name="frm" id="frm" th:object="${memberVO}" method="post" action="/member/passwd_update_proc">
    <input type="hidden" name="memberno" th:value="${memberVO.memberno}">

    <div class="form-group">
      <label>현재 패스워드*</label> 
      <input type='password' name='current_passwd' id='current_passwd' required
             placeholder="현재 패스워드"
             class="form-control form-control-sm" style="width: 100%;">
      <div id='current_passwd_msg' style='width: 100%; text-align: center;'></div>
    </div>
    
    <div class="form-group">
      <label>새로운 패스워드*</label> 
      <input type='password' name='passwd' id='passwd' required
             placeholder="새로운 패스워드"
             class="form-control form-control-sm" style="width: 100%;">
    </div>

    <div class="form-group">
      <label>새로운 패스워드 확인*</label>
      <input type='password' name='passwd2' id='passwd2' required
             placeholder="패스워드 확인"
             class="form-control form-control-sm" style="width: 100%;">
      <span id='passwd2_msg'></span>
    </div>
    
    <div class="content_body_bottom">
      <button type="button" id='btn_send' class="btn btn-secondary btn-sm">저장</button>
      <button type="button" onclick="history.back();" class="btn btn-secondary btn-sm">취소</button>
    </div>
  </form>
</div>

</div>
</html>
