<!DOCTYPE html>
<html layout:decorate="~{layout}">
<div layout:fragment="content">

<style>
  /* 회원 유형 선택 박스 스타일 */
  .role-option {
    display: inline-block;
    width: 180px;
    height: 220px;
    border: 3px solid #333;
    border-radius: 10px;
    margin: 20px;
    text-align: center;
    cursor: pointer;
    transition: border-color 0.3s;
  }
  .role-option img {
    width: 100px;
    height: 100px;
    margin-top: 20px;
  }
  .role-option.selected {
    border-color: #007bff;
  }
  .role-option input[type="radio"] {
    display: none;
  }
  /* 아이디 중복 메시지 스타일 */
  .span_warning {
    color: red;
  }
  .span_info {
    color: green;
  }
</style>

<script th:inline="javascript">
  window.onload = () => {
    // Enter키 입력 방지 (회원명, 아이디, 비밀번호)
    ['mname', 'id', 'passwd'].forEach(id => {
      document.getElementById(id).addEventListener('keypress', (e) => {
        if (e.key === 'Enter') e.preventDefault();
      });
    });

    // 서버에서 전달된 회원 유형 값으로 초기 선택 표시
    const initialuserType = /*[[${userType}]]*/ null;
    if (initialuserType) {
      document.getElementById('userTypeHidden').value = initialuserType;

      const option = document.querySelector(`.role-option input[value="${initialuserType}"]`).closest('.role-option');
      option.classList.add('selected');
      option.querySelector('input').checked = true;

      toggleBusinessFields();
      document.getElementById('step1').style.display = 'none';
      document.getElementById('step2').style.display = 'block';
    }
  };

  // 아이디 중복 검사
  function checkID() {
    const id = document.getElementById('id');
    const id_msg = document.getElementById('id_msg');

    if (id.value.trim().length === 0) {
      id_msg.innerHTML = 'ID 입력은 필수 입니다. ID(이메일)는 3자이상 권장합니다.';
      id_msg.classList.add('span_warning');
      id.focus();
      return false;
    }

    // 처리중 출력
    id_msg.innerHTML = "<img src='/images/progress.gif' style='width: 5%;'>";

    fetch('./checkID?id=' + encodeURIComponent(id.value))
      .then(response => response.json())
      .then(rdata => {
        if (rdata.cnt > 0) {
          id_msg.innerHTML = '이미 사용중인 ID(이메일) 입니다. 다른 ID(이메일)을 지정해주세요.';
          id_msg.classList.add('span_warning');
          id_msg.classList.remove('span_info');
          id.focus();
        } else {
          id_msg.innerHTML = '사용 가능한 ID(이메일) 입니다.';
          id_msg.classList.remove('span_warning');
          id_msg.classList.add('span_info');
          document.getElementById('passwd').focus();
        }
      })
      .catch(error => {
        console.error('Error:', error);
        id_msg.innerHTML = '서버와 통신 중 오류가 발생했습니다.';
        id_msg.classList.add('span_warning');
      });
  }

  // 회원 유형 선택 시 UI 반영
  function selectRole(option) {
    document.querySelectorAll('.role-option').forEach(el => el.classList.remove('selected'));
    option.classList.add('selected');

    const radio = option.querySelector('input[type="radio"]');
    radio.checked = true;

    document.getElementById('userTypeHidden').value = radio.value;

    toggleBusinessFields();
  }

  // 사업자 인증 영역 표시 토글
  function toggleBusinessFields() {
    const selecteduserType = document.getElementById('userTypeHidden').value;
    const businessField = document.getElementById('business_auth');

    if (selecteduserType === 'supplier') {
      businessField.style.display = 'block';
    } else {
      businessField.style.display = 'none';
    }
  }

  // STEP1 → STEP2 이동
  function showStep2() {
    const selectedRadio = document.querySelector('input[name="userType"]:checked');
    if (!selectedRadio) {
      alert('회원 유형을 선택해주세요.');
      return;
    }
    document.getElementById('userTypeHidden').value = selectedRadio.value;
    toggleBusinessFields();

    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';
  }

  // STEP2 → STEP1으로 돌아가기
  function goBackToRoleSelect() {
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step1').style.display = 'block';

    document.querySelectorAll('.role-option').forEach(el => el.classList.remove('selected'));
    document.getElementById('userTypeHidden').value = '';
    document.querySelectorAll('input[name="userType"]').forEach(radio => radio.checked = false);

    toggleBusinessFields();
  }

  // 회원 가입 폼 검증 및 제출
  function send() {
    const mname = document.getElementById('mname');
    const id = document.getElementById('id');
    const passwd = document.getElementById('passwd');
    const mdate = document.getElementById('mdate');
    const tel = document.getElementById('tel');
    const zipcode = document.getElementById('zipcode');
    const address1 = document.getElementById('address1');
    const address2 = document.getElementById('address2');

    if (mname.value.trim() === '') { alert('성명을 입력하세요.'); mname.focus(); return false; }
    if (id.value.trim() === '') { alert('ID를 입력하세요.'); id.focus(); return false; }
    if (passwd.value.trim() === '') { alert('패스워드를 입력하세요.'); passwd.focus(); return false; }
    if (mdate.value.trim() === '') { alert('생년월일을 입력하세요.'); mdate.focus(); return false; }
    if (tel.value.trim() === '') { alert('전화번호를 입력하세요.'); tel.focus(); return false; }
    if (zipcode.value.trim() === '') { alert('우편번호를 입력하세요.'); zipcode.focus(); return false; }
    if (address1.value.trim() === '') { alert('주소를 입력하세요.'); address1.focus(); return false; }
    if (address2.value.trim() === '') { alert('상세 주소를 입력하세요.'); address2.focus(); return false; }

    const selecteduserTypeRadio = document.querySelector('input[name="userType"]:checked');
    if (!selecteduserTypeRadio) {
      alert('회원 유형을 선택해주세요.');
      return false;
    }
    const selecteduserType = selecteduserTypeRadio.value;

    if (selecteduserType === 'supplier') {
      const fileInput = document.getElementById('business_file');
      if (!fileInput.value) {
        alert('사업자 인증 자료를 업로드해주세요.');
        return false;
      }

      const file = fileInput.files[0];
      const allowedExtensions = ['jpg', 'jpeg', 'png', 'pdf'];
      const extension = file.name.split('.').pop().toLowerCase();
      const maxSize = 5 * 1024 * 1024;

      if (!allowedExtensions.includes(extension)) {
        alert('업로드 가능한 파일 형식은 JPG, JPEG, PNG, PDF 입니다.');
        return false;
      }
      if (file.size > maxSize) {
        alert('파일 크기는 5MB 이하로 업로드해주세요.');
        return false;
      }
    }

    if (confirm("회원 가입을 완료하시겠습니까?")) {
      alert("가입이 완료되었습니다!");
      document.getElementById('frm').submit();
    }
  }
</script>

<div class="title_line">회원 가입(*: 필수)</div>

<div style="width: 60%; margin: 0 auto;">
  <form name="frm" id="frm" th:object="${memberVO}" method="post" action="/member/create" enctype="multipart/form-data">

    <!-- STEP 1: 회원 유형 선택 -->
    <div id="step1" style="text-align: center; padding: 50px;">
      <h2>당신은 어떤 회원인가요?</h2>

      <div onclick="selectRole(this)" class="role-option">
        <input type="radio" name="userType" value="user">
        <img src="/images/user.png" alt="소비자">
        <div>소비자</div>
      </div>

      <div onclick="selectRole(this)" class="role-option">
        <input type="radio" name="userType" value="supplier">
        <img src="/images/member.jpg" alt="공급자">
        <div>공급자</div>
      </div>

      <input type="hidden" id="userTypeHidden" value="">

      <div style="margin-top: 30px;">
        <button type="button" class="btn btn-success" onclick="showStep2()">다음</button>
      </div>
    </div>

    <!-- STEP 2: 상세 정보 입력 -->
    <div id="step2" style="display: none;">
      <div class="form-group">
        <label for="mname">성명*</label>
        <input type="text" id="mname" name="mname" class="form-control">
      </div>

      <div class="form-group">
        <label for="id">아이디(이메일)*</label>
        <input type="text" id="id" name="id" class="form-control" onblur="checkID()">
        <button type="button" onclick="checkID()" class="btn btn-info btn-sm" style="display: inline-block; vertical-align: top; margin-left: 5px;">중복확인</button>
        <span id="id_msg"></span>
      </div>

      <div class="form-group">
        <label for="passwd">비밀번호*</label>
        <input type="password" id="passwd" name="passwd" class="form-control">
      </div>

      <div class="form-group">
        <label for="mdate">생년월일*</label>
        <input type="date" id="mdate" name="mdate" class="form-control">
      </div>

      <div class="form-group">
        <label for="tel">전화번호*</label>
        <input type="tel" id="tel" name="tel" class="form-control">
      </div>

      <div class="form-group">
        <label for="zipcode">우편번호*</label>
        <input type="text" id="zipcode" name="zipcode" class="form-control">
      </div>

      <div class="form-group">
        <label for="address1">주소*</label>
        <input type="text" id="address1" name="address1" class="form-control">
      </div>

      <div class="form-group">
        <label for="address2">상세주소*</label>
        <input type="text" id="address2" name="address2" class="form-control">
      </div>

      <!-- 사업자 인증 파일 업로드 (공급자일 경우에만) -->
      <div id="business_auth" style="display: none; margin-top: 20px;">
        <label for="business_file">사업자 인증 자료 업로드*</label>
        <input type="file" id="business_file" name="business_file" accept=".jpg,.jpeg,.png,.pdf" class="form-control-file">
      </div>

      <div style="margin-top: 30px;">
        <button type="button" class="btn btn-primary" onclick="send()">회원가입</button>
        <button type="button" class="btn btn-secondary" onclick="goBackToRoleSelect()">이전</button>
      </div>
    </div>

  </form>
</div>

</div>
</html>
