<!DOCTYPE html>
<html layout:decorate="~{layout}">
<div layout:fragment="content">

<link rel="stylesheet" href="/css/member.css">

<script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

<script>
  let timer = null;
  let timeLeft = 300;

  function startTimer() {
    clearInterval(timer);
    timeLeft = 300;
    updateTimerDisplay();

    timer = setInterval(() => {
      timeLeft--;
      updateTimerDisplay();
      if (timeLeft <= 0) {
        clearInterval(timer);
        const msg = document.getElementById('code_msg');
        msg.style.display = 'block';
        msg.innerText = '인증 시간이 만료되었습니다.';
        msg.className = 'feedback-text span_warning';
      }
    }, 1000);
  }

  function updateTimerDisplay() {
    const min = String(Math.floor(timeLeft / 60)).padStart(2, '0');
    const sec = String(timeLeft % 60).padStart(2, '0');
    document.getElementById('timer').innerText = `${min}:${sec}`;
  }

  function sendCode() {
    const email = document.getElementById('email').value;
    if (!email.includes('@')) {
      alert('유효한 이메일을 입력하세요.');
      return;
    }

    fetch('/member/send_code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: 'email=' + encodeURIComponent(email)
    })
    .then(res => res.text())
    .then(result => {
      const msg = document.getElementById('email_msg');
      msg.style.display = 'block';
      if (result === 'success') {
        msg.innerText = '이메일로 인증코드를 보냈습니다.';
        msg.className = 'feedback-text span_info';
        startTimer();
      } else {
        msg.innerText = '이메일 전송에 실패했습니다.';
        msg.className = 'feedback-text span_warning';
      }
    });
  }

  function verifyCode() {
    if (timeLeft <= 0) {
      const msg = document.getElementById('code_msg');
      msg.style.display = 'block';
      msg.innerText = '인증 시간이 만료되었습니다.';
      msg.className = 'feedback-text span_warning';
      return;
    }

    const email = document.getElementById('email').value;
    const code = document.getElementById('code').value;

    fetch('/member/verify_code', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: 'email=' + encodeURIComponent(email) + '&code=' + encodeURIComponent(code)
    })
    .then(res => res.text())
    .then(result => {
      const msg = document.getElementById('code_msg');
      msg.style.display = 'block';
      if (result === 'verified') {
        msg.textContent = '본인 인증이 확인되었습니다.';
        msg.className = 'feedback-text span_info';
        document.getElementById('verified').value = 'Y';
        clearInterval(timer);
        document.getElementById('timer').innerText = '';
      } else {
        msg.textContent = '인증 실패 (' + result + ')';
        msg.className = 'feedback-text span_warning';
      }
    });
  }

  function execDaumPostcode() {
    new daum.Postcode({
      oncomplete: function(data) {
        document.getElementById('zipcode').value = data.zonecode;
        document.getElementById('address1').value = data.roadAddress || data.jibunAddress;
        document.getElementById('address2').focus();
      }
    }).open();
  }

  function checkId() {
    const id = document.getElementById('username').value;
    if (!id) return alert('아이디를 입력하세요.');

    fetch('/member/check_id?id=' + encodeURIComponent(id))
      .then(response => response.json())
      .then(data => {
        const msg = document.getElementById('id_msg');
        msg.textContent = data.available ? '사용 가능한 아이디입니다' : '이미 사용 중인 아이디입니다';
        msg.style.color = data.available ? 'green' : 'red';
      });
  }

  function mergePhoneBeforeSubmit() {
    const tel1 = document.getElementById('tel1').value;
    const tel2 = document.getElementById('tel2').value;
    const tel3 = document.getElementById('tel3').value;
    if (!tel2 || !tel3) {
      alert("전화번호를 모두 입력해주세요.");
      return false;
    }
    const fullTel = `${tel1}-${tel2}-${tel3}`;
    const telInput = document.createElement('input');
    telInput.type = 'hidden';
    telInput.name = 'tel';
    telInput.value = fullTel;
    document.getElementById('frm').appendChild(telInput);
    return true;
  }

  function selectUserType(type) {
    document.getElementById('userTypeInput').value = type;

    if (type === 'supplier') {
      document.getElementById('business_auth').style.display = 'block';
      document.getElementById('business_file').required = true;
    } else {
      document.getElementById('business_auth').style.display = 'none';
      document.getElementById('business_file').required = false;
    }

    document.getElementById('step1').style.display = 'none';
    document.getElementById('step2').style.display = 'block';

    document.getElementById('step1-indicator').classList.remove('active');
    document.getElementById('step2-indicator').classList.add('active');
    document.getElementById('line1').classList.add('active');
  }

  function cancelSignup() {
    document.getElementById('step2').style.display = 'none';
    document.getElementById('step1').style.display = 'block';

    document.getElementById('step1-indicator').classList.add('active');
    document.getElementById('step2-indicator').classList.remove('active');
    document.getElementById('line1').classList.remove('active');
  }
</script>


<!-- STEP INDICATOR -->
<div class="step-indicator">
  <div id="step1-indicator" class="step active">
    <div class="step-circle">step 1</div>
    <div class="step-label">유형 선택</div>
  </div>
  <div id="line1" class="step-line"></div>
  <div id="step2-indicator" class="step">
    <div class="step-circle">step 2</div>
    <div class="step-label">정보 입력</div>
  </div>
  <div id="line2" class="step-line"></div>
  <div id="step3-indicator" class="step">
    <div class="step-circle">step 3</div>
    <div class="step-label">가입 완료</div>
  </div>
</div>


<!-- STEP 1 -->
<div id="step1">
  <div class="form-group" style="text-align: center;">
    <label style="font-weight: bold; font-size: 18px;">회원 유형을 선택하세요*</label>
    <div style="display: flex; gap: 40px; justify-content: center; margin-top: 20px;">
      <div class="role-option" onclick="selectUserType('user')">
        <input type="radio" name="userType" id="userType_user" value="user" style="display: none;">
        <img src="/images/user.png" alt="소비자">
        <p>소비자</p>
      </div>
      <div class="role-option" onclick="selectUserType('supplier')">
        <input type="radio" name="userType" id="userType_supplier" value="supplier" style="display: none;">
        <img src="/images/supplier.png" alt="공급자">
        <p>공급자</p>
      </div>
    </div>
  </div>
</div>

<!-- STEP 2 -->
<form id="frm" method="post" action="/member/create" enctype="multipart/form-data" onsubmit="return mergePhoneBeforeSubmit();">
  <input type="hidden" id="userTypeInput" name="userType" value="">

  <div id="step2" style="display: none; max-width: 480px; margin: 0 auto;">
    <div id="business_auth" style="display: none;">
      <label for="business_file">사업자 등록증*</label>
      <input type="file" id="business_file" name="business_fileMF" class="form-control input-sm">
    </div>

    <label>성명*</label>
    <input type="text" id="mname" name="mname" class="form-control input-sm uniform-size" required>

    <label>아이디*</label>
    <div class="form-row">
      <input type="text" id="username" name="id" class="form-control input-sm uniform-size flex-grow-1" required>
      <button type="button" onclick="checkId()" class="btn btn-outline-success btn-sm uniform-btn">중복 확인</button>
    </div>
    <span id="id_msg" class="feedback-text"></span><br>

    <label>이메일*</label>
    <div class="form-row">
      <input type="email" id="email" name="email" class="form-control input-sm uniform-size flex-grow-1" required>
      <button type="button" onclick="sendCode()" class="btn btn-outline-success btn-sm uniform-btn">코드 전송</button>
    </div>
    <span id="email_msg" class="feedback-text span_info" style="display: none;">이메일로 인증코드를 보냈습니다.</span><br>

    <label>인증코드 입력</label>
    <div class="form-row">
      <input type="text" id="code" class="form-control input-sm uniform-size flex-grow-1" required>
      <button type="button" onclick="verifyCode()" class="btn btn-outline-primary btn-sm uniform-btn">확인</button>
    </div>
    <span id="code_msg" class="feedback-text span_info" style="display: none;">본인 인증이 확인되었습니다.</span>
    <input type="hidden" id="verified" name="verified" value="N">

    <label>비밀번호*</label>
    <input type="password" id="passwd" name="passwd" class="form-control input-sm uniform-size" required>

    <label>전화번호*</label>
    <div class="form-row">
      <select id="tel1" class="form-control uniform-size"><option value="010">010</option><option value="011">011</option></select>
      <span>-</span>
      <input type="text" id="tel2" maxlength="4" class="form-control uniform-size" required>
      <span>-</span>
      <input type="text" id="tel3" maxlength="4" class="form-control uniform-size" required>
    </div>

    <label>우편번호*</label>
    <div class="form-row">
      <input type="text" id="zipcode" name="zipcode" class="form-control uniform-size" readonly required>
      <button type="button" onclick="execDaumPostcode()" class="btn btn-outline-primary btn-sm uniform-btn">주소 검색</button>
    </div>

    <label>기본주소*</label>
    <input type="text" id="address1" name="address1" class="form-control uniform-size" readonly required>

    <label>상세주소*</label>
    <input type="text" id="address2" name="address2" class="form-control uniform-size" required>

    <div style="margin-top: 30px; text-align: center;">
      <button type="submit" class="btn btn-primary btn-sm uniform-btn">회원가입</button>
      <button type="button" onclick="cancelSignup()" class="btn btn-secondary btn-sm uniform-btn">취소</button>
    </div>
  </div>
</form>


<!-- STEP 3 -->
<div id="step3" style="display: none; text-align: center; margin-top: 50px;">
  <h3 id="completeMessage"></h3>
  <a href="/member/login" class="btn btn-success mt-3">로그인 페이지로 이동</a>
</div>

</div>
</html>
