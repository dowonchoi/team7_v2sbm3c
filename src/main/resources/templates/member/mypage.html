<!DOCTYPE html>
<html layout:decorate="~{layout}">
<div layout:fragment="content">

<link rel="stylesheet" href="/css/mypage.css">

<div class="mypage-container">
  <div class="mypage-title">ë§ˆì´í˜ì´ì§€</div>

  <table class="mypage-table">
    <tr><th>ì•„ì´ë””</th><td th:text="${memberVO.id}"></td></tr>
    <tr><th>ì´ë©”ì¼</th><td th:text="${memberVO.email}"></td></tr>  
    <tr><th>ì´ë¦„</th><td th:text="${memberVO.mname}"></td></tr>
    <tr><th>ì „í™”ë²ˆí˜¸</th><td th:text="${memberVO.tel}"></td></tr>
    <tr><th>ì£¼ì†Œ</th><td th:text="${memberVO.address1 + ' ' + memberVO.address2}"></td></tr>
    <tr><th>ê°€ì…ì¼</th><td th:text="${memberVO.mdate}"></td></tr>
    <tr><th>ë“±ê¸‰</th><td th:text="${memberVO.grade}"></td></tr>
    <tr th:if="${memberVO.grade != null and memberVO.grade >= 5 and memberVO.grade <= 15}">
      <th>ìŠ¹ì¸ ìƒíƒœ</th>
      <td>
        <span th:if="${memberVO.supplier_approved == 'Y'}" class="approval-status status-approved">ìŠ¹ì¸</span>
        <span th:if="${memberVO.supplier_approved == 'N'}" class="approval-status status-pending">ìŠ¹ì¸ ëŒ€ê¸°</span>
        <span th:if="${memberVO.supplier_approved == 'R'}" class="approval-status status-rejected">ìŠ¹ì¸ ê±°ì ˆ</span>
        <span th:if="${memberVO.supplier_approved == null}" class="approval-status status-none">ì •ë³´ ì—†ìŒ</span>
      </td>
    </tr>
    <!-- ğŸ”¥ ë“±ê¸‰ ì•ˆë‚´ ë¬¸êµ¬ ì¶”ê°€ -->
    <div style="margin: 20px 0; color: #ad6739; font-size: 14px;">
      <b>ë“±ê¸‰ ì•ˆë‚´:</b> 
      ê´€ë¦¬ì(1~4), íŒë§¤ì—…ì²´(5~15), íšŒì›(16~39), íƒˆí‡´íšŒì›(40~59)
    </div>
  </table>

  <div class="btn-group">
    <a class="btn btn-primary" th:href="@{/member/update}">ì •ë³´ ìˆ˜ì •</a>
    <a class="btn btn-danger" th:href="@{/member/delete}">íšŒì› íƒˆí‡´</a>
    <a class="btn btn-secondary" th:href="@{/login/mylist}">ë¡œê·¸ì¸ ë‚´ì—­ í™•ì¸</a>
  </div>

  <div class="section-title">ì‡¼í•‘ ì •ë³´</div>
  <div class="info-boxes">
    <div class="info-box"><strong>ì£¼ë¬¸ë‚´ì—­</strong><span th:text="${orderCount} + 'ê±´'"></span></div>
    <div class="info-box"><strong>ì·¨ì†Œ/êµí™˜/ë°˜í’ˆ</strong><span th:text="${cancelCount} + 'ê±´'"></span></div>
    <div class="info-box"><strong>ì¥ë°”êµ¬ë‹ˆ</strong><span th:text="${cartCount} + 'ê±´'"></span></div>
  </div>

  <div class="section-title" 
     th:if="${memberVO.grade < 5 or memberVO.grade > 15}">
    ì·¨ì†Œ/êµí™˜/ë°˜í’ˆ ì‹ ì²­ ë‚´ì—­

    <!-- ì†Œë¹„ììš©: /cancel/list -->
    <a th:if="${memberVO.grade >= 16 and memberVO.grade <= 39}" 
      th:href="@{/cancel/list}" 
      class="btn-more" style="float:right; font-size: 14px;">
      ë‚´ì—­ ë³´ê¸° â¤
    </a>

    <!-- ê´€ë¦¬ììš©: /cancel/admin/list -->
    <a th:if="${memberVO.grade >= 1 and memberVO.grade <= 4}" 
      th:href="@{/cancel/admin/list}" 
      class="btn-more" style="float:right; font-size: 14px;">
      ì „ì²´ ë‚´ì—­ ë³´ê¸° â¤
    </a>
  </div>

  <!-- âœ… ì‹ ì²­ ë‚´ì—­ ìµœê·¼ 3ê±´ë§Œ ì¶œë ¥ (ì†Œë¹„ìë§Œ ë³´ì„) -->
  <div th:if="${memberVO.grade >= 16 and memberVO.grade <= 39}" class="order-table">
    <table>
      <thead>
        <tr>
          <th>ì‹ ì²­ì¼</th>
          <th>ì‹ ì²­ë²ˆí˜¸</th>
          <th>ì‹ ì²­ìœ í˜•</th>
          <th>ìƒíƒœ</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="cancel, stat : ${recentCancels}" th:if="${stat.index < 3}">
          <td th:text="${#dates.format(cancel.created_at, 'yyyy-MM-dd')}">2025-07-20</td>
          <td th:text="${cancel.cancel_id}">23</td>
          <td th:text="${cancel.type}">ë°˜í’ˆ</td>
          <td th:text="${cancel.status}">ì²˜ë¦¬ì¤‘</td>
        </tr>
        <tr th:if="${#lists.isEmpty(recentCancels)}">
          <td colspan="4">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- âœ… ê´€ë¦¬ììš© ì „ì²´ ëª©ë¡ ì¶œë ¥ -->
  <div th:if="${memberVO.grade >= 1 and memberVO.grade <= 4}" class="order-table">
    <table>
      <thead>
        <tr>
          <th>ì‹ ì²­ì¼</th>
          <th>ì‹ ì²­ë²ˆí˜¸</th>
          <th>íšŒì›ë²ˆí˜¸</th>
          <th>ì‹ ì²­ìœ í˜•</th>
          <th>ìƒíƒœ</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="cancel : ${cancelList}">
          <td th:text="${#dates.format(cancel.created_at, 'yyyy-MM-dd')}"></td>
          <td th:text="${cancel.cancel_id}"></td>
          <td th:text="${cancel.memberno}"></td>
          <td th:text="${cancel.type}"></td>
          <td th:text="${cancel.status}"></td>
        </tr>
        <tr th:if="${#lists.isEmpty(cancelList)}">
          <td colspan="5">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- âœ… ê³µê¸‰ììš©: ë‚´ê°€ ë“±ë¡í•œ ìƒí’ˆì— ëŒ€í•´ ì†Œë¹„ìê°€ ì‹ ì²­í•œ ì·¨ì†Œ/êµí™˜/ë°˜í’ˆ ëª©ë¡ -->
  <div th:if="${memberVO.grade >= 5 and memberVO.grade <= 15}" class="section-title">
    ë‚´ ìƒí’ˆ ê´€ë ¨ ì‹ ì²­ ë‚´ì—­
    <a th:href="@{/cancel/supplier/list}" class="btn-more" style="float:right; font-size: 14px;">
      ì „ì²´ ë³´ê¸° â¤
    </a>
  </div>

  <div th:if="${memberVO.grade >= 5 and memberVO.grade <= 15}" class="order-table">
    <table>
      <thead>
        <tr>
          <th>ì‹ ì²­ì¼</th>
          <th>ì‹ ì²­ë²ˆí˜¸</th>
          <th>ìƒí’ˆëª…</th>
          <th>ì‹ ì²­ìœ í˜•</th>
          <th>ìƒíƒœ</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="cancel, stat : ${supplierCancelList}" th:if="${stat.index < 3}">
          <td th:text="${#dates.format(cancel.created_at, 'yyyy-MM-dd')}">2025-07-21</td>
          <td th:text="${cancel.cancel_id}">23</td>
          <td th:text="${cancel.pname}">ì˜ˆì‹œ ìƒí’ˆ</td>
          <td th:text="${cancel.type}">ë°˜í’ˆ</td>
          <td th:text="${cancel.status}">ì²˜ë¦¬ì¤‘</td>
        </tr>
        <tr th:if="${#lists.isEmpty(supplierCancelList)}">
          <td colspan="5">ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="section-title">í˜œíƒ ê´€ë¦¬</div>
  <div class="info-boxes">
    <!-- <div class="info-box"><strong>ì¿ í°</strong><span th:text="${couponCount} + 'ì¥'"></span></div> -->
    <div class="info-box"><strong>í¬ì¸íŠ¸</strong><span th:text="${pointAmount} + 'P'"></span></div>
  </div>

  <div class="section-title">
    ìµœê·¼ ì£¼ë¬¸ ë‚´ì—­

    <!-- ì†Œë¹„ì (grade 16~39) -->
    <a th:if="${memberVO.grade >= 16 and memberVO.grade <= 39}" 
      th:href="@{/order/list_by_member}" 
      class="btn-more" style="float:right; font-size: 14px;">ë”ë³´ê¸° â¤</a>

    <!-- ê³µê¸‰ì (grade 5~15) -->
    <a th:if="${memberVO.grade >= 5 and memberVO.grade <= 15}" 
      th:href="@{/order/list_by_supplier}" 
      class="btn-more" style="float:right; font-size: 14px;">ë”ë³´ê¸° â¤</a>
    </div>

    <div class="order-table">
      <table>
        <thead>
          <tr><th>ì£¼ë¬¸ì¼ì</th><th>ì£¼ë¬¸ë²ˆí˜¸</th><th>ìƒí’ˆëª…</th><th>ê²°ì œê¸ˆì•¡</th><th>ìƒíƒœ</th></tr>
        </thead>
        <tbody>
          <!-- ğŸ”¥ ìµœê·¼ ì£¼ë¬¸ ë‚´ì—­ 3ê±´ë§Œ ì¶œë ¥ -->
          <tr th:each="order, stat : ${recentOrders}"
              th:if="${stat.index < 3}">
            <td th:text="${#dates.format(order.rdate, 'yyyy-MM-dd HH:mm')}"></td>
            <td th:text="${order.orderno}"></td>

            <td>
              <ul>
                <!-- ì£¼ë¬¸ ìƒì„¸(ìƒí’ˆ ëª©ë¡) ë°˜ë³µ -->
                <li th:each="item : ${allOrderItems[__${stat.index}__]}">
                  <span th:text="${item.pname}"></span>
                </li>
              </ul>
            </td>

            <td th:text="${order.total}"></td>
            <td th:text="${order.status}"></td>
          </tr>

          <tr th:if="${#lists.isEmpty(recentOrders)}">
            <td colspan="5">ìµœê·¼ ì£¼ë¬¸ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- âœ… ì†Œë¹„ì ì „ìš© (grade 16~39): ì¶”ì²œ ìƒí’ˆ ëª©ë¡ + ë”ë³´ê¸° ë²„íŠ¼ -->
  <div th:if="${memberVO.grade != null and memberVO.grade >= 16 and memberVO.grade <= 39}">
    <div class="section-title">
      ì¶”ì²œ ìƒí’ˆ
      <button id="toggleGoodBtn"
              onclick="toggleGoodProducts()"
              style="float: right; font-size: 14px;">ë”ë³´ê¸° â¤</button>
    </div>

    <div id="goodProductsAjax"
        class="recent-products"
        style="display: flex; flex-wrap: wrap; gap: 16px;">
    </div>
  </div>

  <!-- âœ… ê³µê¸‰ì ì „ìš© (grade 5~15): ì¶”ì²œ ìƒí’ˆ ëª©ë¡ ì¶œë ¥ -->
  <div th:if="${memberVO.grade != null and memberVO.grade >= 5 and memberVO.grade <= 15}">
    <div class="section-title">
      ì¶”ì²œ ìƒí’ˆ
      <a href="/productsgood/supplier_products_liked" class="btn-more" 
        style="float: right; font-size: 14px;">
        ë”ë³´ê¸° â¤
      </a>
    </div>
  </div>

  <!-- âœ… ê´€ë¦¬ì ì „ìš© (grade 1~4): ì „ì²´ ì¶”ì²œ ìƒí’ˆ ëª©ë¡ AJAX ì¶œë ¥ -->
  <div th:if="${memberVO.grade != null and memberVO.grade >= 1 and memberVO.grade <= 4}">
    <div class="section-title">
      ì „ì²´ ì¶”ì²œ ìƒí’ˆ ëª©ë¡
    </div>

    <div id="adminGoodProductsAjax"
        class="recent-products"
        style="display: flex; flex-wrap: wrap; gap: 16px;">
    </div>
  </div>


  <script>
    let isGoodExpanded = false;

    function renderGoodProducts(products) {
      const userContainer = document.getElementById('goodProductsAjax');
      const adminContainer = document.getElementById('adminGoodProductsAjax');

      // ê´€ë¦¬ì ì „ìš© ë Œë”ë§ (ì „ì²´ ì¶œë ¥, ë”ë³´ê¸° ì—†ìŒ)
      if (adminContainer && !userContainer) {
        adminContainer.innerHTML = '';
        if (products.length === 0) {
          adminContainer.innerHTML = '<div>ì¶”ì²œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        products.forEach((product) => {
          const div = document.createElement('div');
          div.classList.add('product-card');
          div.style.width = '120px';
          div.style.textAlign = 'center';

          div.innerHTML = `
            <a href="/products/read?productsno=${product.productsno}">
              <div>
                ${product.thumb1
                  ? `<img src="/products/storage/${product.thumb1}" alt="${product.title}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;" />`
                  : `<span>ì´ë¯¸ì§€ ì—†ìŒ</span>`}
              </div>
            </a>
            <div style="margin-top: 5px; font-size: 14px;">${product.title}</div>
          `;
          adminContainer.appendChild(div);
        });

        return; // ì¼ë°˜ ì‚¬ìš©ì ë Œë”ë§ì€ í•˜ì§€ ì•ŠìŒ
      }

      // ì¼ë°˜ ì‚¬ìš©ì ì „ìš© ë Œë”ë§ (3ê°œ + ë”ë³´ê¸°)
      if (userContainer) {
        userContainer.innerHTML = '';

        if (products.length === 0) {
          userContainer.innerHTML = '<div>ì¶”ì²œ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        products.forEach((product, index) => {
          const div = document.createElement('div');
          div.classList.add('product-card');
          if (index >= 3) div.classList.add('hidden-good-product');
          div.style.width = '120px';
          div.style.textAlign = 'center';

          div.innerHTML = `
            <a href="/products/read?productsno=${product.productsno}">
              <div>
                ${product.thumb1
                  ? `<img src="/products/storage/${product.thumb1}" alt="${product.title}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;" />`
                  : `<span>ì´ë¯¸ì§€ ì—†ìŒ</span>`}
              </div>
            </a>
            <div style="margin-top: 5px; font-size: 14px;">${product.title}</div>
          `;
          userContainer.appendChild(div);
        });

        document.querySelectorAll('.hidden-good-product').forEach(el => el.style.display = 'none');
      }
    }

    function toggleGoodProducts() {
      const hiddenItems = document.querySelectorAll('.hidden-good-product');
      const toggleBtn = document.getElementById('toggleGoodBtn');
      hiddenItems.forEach(el => el.style.display = isGoodExpanded ? 'none' : 'block');
      toggleBtn.innerText = isGoodExpanded ? 'ë”ë³´ê¸° â–¼' : 'ì ‘ê¸° â–²';
      isGoodExpanded = !isGoodExpanded;
    }

    window.addEventListener('DOMContentLoaded', () => {
      fetch('/products/good_ajax')
        .then(res => res.json())
        .then(data => renderGoodProducts(data));
    });
  </script>


  <div class="section-title">í™œë™ ìš”ì•½</div>
  <div class="info-boxes">
    <div class="info-box"><strong>ìƒí’ˆ í›„ê¸°</strong><span th:text="${reviewCount} + 'ê±´'"></span></div>
    <div class="info-box"><strong>ìƒí’ˆ ë¬¸ì˜</strong><span th:text="${qnaCount} + 'ê±´'"></span></div>
    <div class="info-box"><strong>1:1 ë¬¸ì˜</strong><span th:text="${inquiryCount} + 'ê±´'"></span></div>
  </div>

</div>

</div>
</html>