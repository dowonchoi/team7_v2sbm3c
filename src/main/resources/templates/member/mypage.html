<!DOCTYPE html>
<html layout:decorate="~{layout}">
<div layout:fragment="content">

<link rel="stylesheet" href="/css/mypage.css">

<div class="mypage-container">
  <div class="mypage-title">마이페이지</div>

  <table class="mypage-table">
    <tr><th>아이디</th><td th:text="${memberVO.id}"></td></tr>
    <tr><th>이메일</th><td th:text="${memberVO.email}"></td></tr>  
    <tr><th>이름</th><td th:text="${memberVO.mname}"></td></tr>
    <tr><th>전화번호</th><td th:text="${memberVO.tel}"></td></tr>
    <tr><th>주소</th><td th:text="${memberVO.address1 + ' ' + memberVO.address2}"></td></tr>
    <tr><th>가입일</th><td th:text="${memberVO.mdate}"></td></tr>
    <tr><th>등급</th><td th:text="${memberVO.grade}"></td></tr>
    <tr th:if="${memberVO.grade != null and memberVO.grade >= 5 and memberVO.grade <= 15}">
      <th>승인 상태</th>
      <td>
        <span th:if="${memberVO.supplier_approved == 'Y'}" class="approval-status status-approved">승인</span>
        <span th:if="${memberVO.supplier_approved == 'N'}" class="approval-status status-pending">승인 대기</span>
        <span th:if="${memberVO.supplier_approved == 'R'}" class="approval-status status-rejected">승인 거절</span>
        <span th:if="${memberVO.supplier_approved == null}" class="approval-status status-none">정보 없음</span>
      </td>
    </tr>
    <!-- 🔥 등급 안내 문구 추가 -->
    <div style="margin: 20px 0; color: #ad6739; font-size: 14px;">
      <b>등급 안내:</b> 
      관리자(1~4), 판매업체(5~15), 회원(16~39), 탈퇴회원(40~59)
    </div>
  </table>

  <div class="btn-group">
    <a class="btn btn-primary" th:href="@{/member/update}">정보 수정</a>
    <a class="btn btn-danger" th:href="@{/member/delete}">회원 탈퇴</a>
    <a class="btn btn-secondary" th:href="@{/login/mylist}">로그인 내역 확인</a>
  </div>

  <div class="section-title">쇼핑 정보</div>
  <div class="info-boxes">
    <div class="info-box"><strong>주문내역</strong><span th:text="${orderCount} + '건'"></span></div>
    <div class="info-box"><strong>취소/교환/반품</strong><span th:text="${cancelCount} + '건'"></span></div>
    <div class="info-box"><strong>장바구니</strong><span th:text="${cartCount} + '건'"></span></div>
  </div>

  <div class="section-title" 
     th:if="${memberVO.grade < 5 or memberVO.grade > 15}">
    취소/교환/반품 신청 내역

    <!-- 소비자용: /cancel/list -->
    <a th:if="${memberVO.grade >= 16 and memberVO.grade <= 39}" 
      th:href="@{/cancel/list}" 
      class="btn-more" style="float:right; font-size: 14px;">
      내역 보기 ➤
    </a>

    <!-- 관리자용: /cancel/admin/list -->
    <a th:if="${memberVO.grade >= 1 and memberVO.grade <= 4}" 
      th:href="@{/cancel/admin/list}" 
      class="btn-more" style="float:right; font-size: 14px;">
      전체 내역 보기 ➤
    </a>
  </div>

  <!-- ✅ 신청 내역 최근 3건만 출력 (소비자만 보임) -->
  <div th:if="${memberVO.grade >= 16 and memberVO.grade <= 39}" class="order-table">
    <table>
      <thead>
        <tr>
          <th>신청일</th>
          <th>신청번호</th>
          <th>신청유형</th>
          <th>상태</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="cancel, stat : ${recentCancels}" th:if="${stat.index < 3}">
          <td th:text="${#dates.format(cancel.created_at, 'yyyy-MM-dd')}">2025-07-20</td>
          <td th:text="${cancel.cancel_id}">23</td>
          <td th:text="${cancel.type}">반품</td>
          <td th:text="${cancel.status}">처리중</td>
        </tr>
        <tr th:if="${#lists.isEmpty(recentCancels)}">
          <td colspan="4">신청 내역이 없습니다.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ✅ 관리자용 전체 목록 출력 -->
  <div th:if="${memberVO.grade >= 1 and memberVO.grade <= 4}" class="order-table">
    <table>
      <thead>
        <tr>
          <th>신청일</th>
          <th>신청번호</th>
          <th>회원번호</th>
          <th>신청유형</th>
          <th>상태</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="cancel : ${cancelList}">
          <td th:text="${#dates.format(cancel.created_at, 'yyyy-MM-dd')}"></td>
          <td th:text="${cancel.cancel_id}"></td>
          <td th:text="${cancel.memberno}"></td>
          <td th:text="${cancel.type}"></td>
          <td th:text="${cancel.status}"></td>
        </tr>
        <tr th:if="${#lists.isEmpty(cancelList)}">
          <td colspan="5">신청 내역이 없습니다.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ✅ 공급자용: 내가 등록한 상품에 대해 소비자가 신청한 취소/교환/반품 목록 -->
  <div th:if="${memberVO.grade >= 5 and memberVO.grade <= 15}" class="section-title">
    내 상품 관련 신청 내역
    <a th:href="@{/cancel/supplier/list}" class="btn-more" style="float:right; font-size: 14px;">
      전체 보기 ➤
    </a>
  </div>

  <div th:if="${memberVO.grade >= 5 and memberVO.grade <= 15}" class="order-table">
    <table>
      <thead>
        <tr>
          <th>신청일</th>
          <th>신청번호</th>
          <th>상품명</th>
          <th>신청유형</th>
          <th>상태</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="cancel, stat : ${supplierCancelList}" th:if="${stat.index < 3}">
          <td th:text="${#dates.format(cancel.created_at, 'yyyy-MM-dd')}">2025-07-21</td>
          <td th:text="${cancel.cancel_id}">23</td>
          <td th:text="${cancel.pname}">예시 상품</td>
          <td th:text="${cancel.type}">반품</td>
          <td th:text="${cancel.status}">처리중</td>
        </tr>
        <tr th:if="${#lists.isEmpty(supplierCancelList)}">
          <td colspan="5">신청 내역이 없습니다.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="section-title">혜택 관리</div>
  <div class="info-boxes">
    <!-- <div class="info-box"><strong>쿠폰</strong><span th:text="${couponCount} + '장'"></span></div> -->
    <div class="info-box"><strong>포인트</strong><span th:text="${pointAmount} + 'P'"></span></div>
  </div>

  <div class="section-title">
    최근 주문 내역

    <!-- 소비자 (grade 16~39) -->
    <a th:if="${memberVO.grade >= 16 and memberVO.grade <= 39}" 
      th:href="@{/order/list_by_member}" 
      class="btn-more" style="float:right; font-size: 14px;">더보기 ➤</a>

    <!-- 공급자 (grade 5~15) -->
    <a th:if="${memberVO.grade >= 5 and memberVO.grade <= 15}" 
      th:href="@{/order/list_by_supplier}" 
      class="btn-more" style="float:right; font-size: 14px;">더보기 ➤</a>
  </div>

  <div class="order-table">
    <table>
      <thead>
        <tr><th>주문일자</th><th>주문번호</th><th>상품명</th><th>결제금액</th><th>상태</th></tr>
      </thead>
      <tbody>
        <!-- 🔥 최근 주문 내역 3건만 출력 -->
        <tr th:each="order, stat : ${recentOrders}"
            th:if="${stat.index < 3}">
          <td th:text="${#dates.format(order.rdate, 'yyyy-MM-dd HH:mm')}"></td>
          <td th:text="${order.orderno}"></td>

          <td>
            <ul>
              <!-- 주문 상세(상품 목록) 반복 -->
              <li th:each="item : ${allOrderItems[__${stat.index}__]}">
                <span th:text="${item.pname}"></span>
              </li>
            </ul>
          </td>

          <td th:text="${order.total}"></td>
          <td th:text="${order.status}"></td>
        </tr>

        <tr th:if="${#lists.isEmpty(recentOrders)}">
          <td colspan="5">최근 주문 내역이 없습니다.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- 추천 상품 (찜한 상품 기반) -->
  <div class="section-title">추천 상품
    <button id="toggleGoodBtn" onclick="toggleGoodProducts()" style="float: right; font-size: 14px;">더보기 ▼</button>
  </div>

  <div id="goodProductsAjax" class="recent-products" style="display: flex; flex-wrap: wrap; gap: 16px;"></div>

  <script>
    let isGoodExpanded = false;

    function renderGoodProducts(products) {
      const container = document.getElementById('goodProductsAjax');
      container.innerHTML = '';

      if (products.length === 0) {
        container.innerHTML = '<div>추천 상품이 없습니다.</div>';
        return;
      }

      products.forEach((product, index) => {
        const div = document.createElement('div');
        div.classList.add('product-card');
        if (index >= 3) div.classList.add('hidden-good-product');
        div.style.width = '120px';
        div.style.textAlign = 'center';

        div.innerHTML = `
          <a href="/products/read?productsno=${product.productsno}">
            <div>
              ${product.thumb1
                ? `<img src="/products/storage/${product.thumb1}" alt="${product.title}" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;" />`
                : `<span>이미지 없음</span>`
              }
            </div>
          </a>
          <div style="margin-top: 5px; font-size: 14px;">
            ${product.title}
          </div>
        `;
        container.appendChild(div);
      });

      document.querySelectorAll('.hidden-good-product').forEach(el => el.style.display = 'none');
    }

    function toggleGoodProducts() {
      const hiddenItems = document.querySelectorAll('.hidden-good-product');
      const toggleBtn = document.getElementById('toggleGoodBtn');
      hiddenItems.forEach(el => el.style.display = isGoodExpanded ? 'none' : 'block');
      toggleBtn.innerText = isGoodExpanded ? '더보기 ▼' : '접기 ▲';
      isGoodExpanded = !isGoodExpanded;
    }

    window.addEventListener('DOMContentLoaded', () => {
      fetch('/products/good_ajax')
        .then(res => res.json())
        .then(data => renderGoodProducts(data));
    });
  </script>

  <div class="section-title">활동 요약</div>
  <div class="info-boxes">
    <div class="info-box"><strong>상품 후기</strong><span th:text="${reviewCount} + '건'"></span></div>
    <div class="info-box"><strong>상품 문의</strong><span th:text="${qnaCount} + '건'"></span></div>
    <div class="info-box"><strong>1:1 문의</strong><span th:text="${inquiryCount} + '건'"></span></div>
  </div>

</div>

</div>
</html>